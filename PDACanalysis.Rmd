---
title: "PDAC Analysis"
output: html_notebook
---

```{r}
## Load packages
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
library(cowplot)
library(pracma)
library(RColorBrewer)
library(EnhancedVolcano)
```



Analyze GSE 111672 Datasets

```{r}

pdac1.read <- read.table("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\GSE111672_PDAC-A-indrop-filtered-expMat.txt", sep = "\t", as.is = 1)
pdac1.read <- pdac1.read[-c(9946, 9947), ] ## Duplicates of 1-Mar and 2-Mar genes (excel error??)
rownames(pdac1.read) <- pdac1.read$V1 ## Rownames are stored in the first column of the dataset
pdac1.read <- pdac1.read[, -c(1)] ## Delete extra rownames vector
names(pdac1.read) <- lapply(pdac1.read[1,], as.character) ## Column names are stored in the first row of the dataset
pdac1.read <- pdac1.read[-1,] ## Delete extra colnames vector

pdac2.read <- read.table("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\GSE111672_PDAC-B-indrop-filtered-expMat.txt", sep = "\t", header = TRUE, as.is = 1)
pdac2.read <- pdac2.read[-c(9946, 9947), ]
rownames(pdac2.read) <- pdac2.read$Genes
pdac2.read <- pdac2.read[, -c(1)]

pdac1 <- CreateSeuratObject(counts=pdac1.read, project="PDAC1", min.cells=1, min.features=1)
pdac2 <- CreateSeuratObject(counts=pdac2.read, project="PDAC2", min.cells=1, min.features=1)
```



Initial PDAC Datasets Clustering

```{r}

pdac1 <- preprocessing(pdac1, heatmap=FALSE)
pdac2 <- preprocessing(pdac2, heatmap=FALSE)

pdac1 <- clustering(pdac1, PCs=50, resolution=0.5)
pdac2 <- clustering(pdac2, PCs=50, resolution=0.5)


pdac1.umap <- DimPlot(pdac1, reduction="umap", label=TRUE, pt.size=0.3) + NoLegend()
pdac2.umap <- DimPlot(pdac2, reduction="umap", label=TRUE, pt.size=0.3) + NoLegend()
pdac1.umap + pdac2.umap

## Checkpoint

save(pdac1, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\pdac1")
save(pdac2, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\pdac2")

load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\pdac1")
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\pdac2")
```



PDAC Datasets Clustering Comparison 

```{r}

pdac1.read.cell.labels <- read.table("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\GSE111672_PDAC-A-indrop-filtered-expMat.txt", nrows=1, header=FALSE, sep = "\t", as.is = 1)
pdac1.read.cell.labels <- t(pdac1.read.cell.labels)
pdac1.read.cell.labels <- pdac1.read.cell.labels[-c(1),]
pdac1@meta.data$orig_clusters <- pdac1.read.cell.labels

pdac2.read.cell.labels <- read.table("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\GSE111672_PDAC-B-indrop-filtered-expMat.txt", nrows=1, header=FALSE, sep = "\t", as.is = 1)
pdac2.read.cell.labels <- t(pdac2.read.cell.labels)
pdac2.read.cell.labels <- pdac2.read.cell.labels[-c(1),]
pdac2@meta.data$orig_clusters <- pdac2.read.cell.labels


pdac1.umap.orig <- DimPlot(pdac1, group.by = "orig_clusters", label=TRUE, pt.size=0.2) + NoLegend()
pdac2.umap.orig <- DimPlot(pdac2, group.by = "orig_clusters", label=TRUE, pt.size=0.2) + NoLegend()

pdac1.umap.orig
pdac2.umap.orig
pdac1.idents <- c("Ductal 1", "Ductal 2", "Ductal 3", "Cancer clone B", "Macrophages", "Cancer clone A", "Ductal 4", "T & NK", "Tuft", "Endocrine & RBCs", "Acinar", "Endothelial")

pdac2.idents <- c("Ductal 1", "Ductal 2", "Cancer clone A", "Ductal 3", "Endothelial", "Macrophages", "Ductal 4", "Tuft & Endocrine", "Acinar")

names(pdac1.idents) <- levels(pdac1)
pdac1 <- RenameIdents(pdac1, pdac1.idents)

names(pdac2.idents) <- levels(pdac2)
pdac2 <- RenameIdents(pdac2, pdac2.idents)

```



```{r}

pdac1 <- FindNeighbors(pdac1, dims = 1:50)
pdac1 <- FindClusters(pdac1, resolution = 0.5, algorithm = 3)
pdac1.markers <- FindAllMarkers(pdac1, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
pdac1.top25 <- pdac1.markers %>% group_by(cluster) %>% top_n(n=25, wt=avg_logFC)

pdac2 <- FindNeighbors(pdac2, dims = 1:50)
pdac2 <- FindClusters(pdac2, resolution = 0.5, algorithm = 3)
pdac2.markers <- FindAllMarkers(pdac2, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
pdac2.top25 <- pdac2.markers %>% group_by(cluster) %>% top_n(n=25, wt=avg_logFC)

```



Combined analysis of pdac datasets

```{r}
## Merge and process datasets 
pdac.combined <- merge(pdac1, y=pdac2, add.cell.ids=c("Patient 1", "Patient 2"), project="Merged PDAC")
pdac.combined <- preprocessing(pdac.combined)
pdac.combined <- clustering(pdac.combined)

## Create UMAPS
pdac.combined.umap <- DimPlot(pdac.combined, reduction="umap")
pdac.combined.identsep.umap <- DimPlot(pdac.combined, reduction="umap", group.by="orig.ident")
pdac.combined.umap + pdac.combined.identsep.umap


```



PDAC Merged Heatmap Comparison 

```{r}
pdac.combined.meta.data <- pdac.combined@meta.data
pdac1.meta.data <- pdac1@meta.data
pdac2.meta.data <- pdac2@meta.data

pdac1.meta.data$rownames <- rownames(pdac1.meta.data)
pdac1.meta.data$rownames <- paste0("Patient 1_", pdac1.meta.data$rownames)

pdac2.meta.data$rownames <- rownames(pdac2.meta.data)
pdac2.meta.data$rownames <- paste0("Patient 2_", pdac2.meta.data$rownames)
pdac2.meta.data$seurat_clusters <- paste0("B", pdac2.meta.data$seurat_clusters)

pdac.combined.meta.data$rownames <- rownames(pdac.combined.meta.data)
mergetest1 <- merge(pdac.combined.meta.data, pdac1.meta.data, by=c("rownames", "nCount_RNA"))
mergetest2 <- merge(pdac.combined.meta.data, pdac2.meta.data, by=c("rownames", "nCount_RNA"))
pdac.combined.merged <- rbind(mergetest1, mergetest2)

uniqueclusters1 <- as.matrix(unique(pdac.combined.merged$seurat_clusters.x))
uniqueclusters2 <- as.matrix(unique(pdac.combined.merged$seurat_clusters.y))

pdac.distribution.table <- dist_table(pdac.combined.merged, uniqueclusters1, uniqueclusters2, 6, 12)

pdac.proportions.table <- prop_table(pdac.distribution.table, uniqueclusters1, uniqueclusters2)

uniqueclusters2 <- c("Acinar", "Cancer clone A", "Ductal 4", "Cancer clone B", "Ductal 3", "Ductal 1", "Ductal 2", "Tuft", "T & NK", "Endothelial", "Macrophages", "Endocrine & RBCs", "B_Acinar", "B_Cancer clone A", "B_Ductal 4", "B_Ductal 3", "B_Ductal 2", "B_Tuft & Endocrine", "B_Macrophages", "B_Ductal 1", "B_Endothelial")

pdac.comparison.heatmap <- ggplot_heatmap(pdac.proportions.table, uniqueclusters1, uniqueclusters2, c("RdGy"), c("Merged Clustering"), c("Individual Clustering"))

pdac.comparison.heatmap

```



Integrated analysis of datasets 

```{r}

pdac.list <- list(pdac1, pdac2)
pdac.anchors <- FindIntegrationAnchors(object.list=pdac.list, dims=1:50)
pdac.integrated <- IntegrateData(anchorset=pdac.anchors, dims=1:50)
DefaultAssay(pdac.integrated) <- "RNA"

pdac.integrated <- preprocessing(pdac.integrated, heatmap=FALSE)
pdac.integrated <- clustering(pdac.integrated, PCs=50, genes=FALSE)
pdac.integrated <- RunUMAP(pdac.integrated, dims=1:50)
pdac.integrated.heatmap <- DimPlot(pdac.integrated, reduction="umap", label=TRUE, pt.size = 0.1) + NoLegend()

labels <- c("Ductal 1", "Ductal 2", "Ductal 3", "Cancer clone A (pat. B)", "Ductal 4", "Cancer clone B (pat. A)", "Endothelial", "Macrophages", "Cancer clone A (pat. A)", "NK & T 1", "Tuft", "NK & T 2", "Acinar", "Endocrine & RBCs")

names(labels) <- levels(pdac.integrated)
pdac.integrated <- RenameIdents(pdac.integrated, labels)
pdac.integrated@meta.data$seurat_clusters <- pdac.integrated@active.ident
DimPlot(pdac.integrated, reduction="umap", label=TRUE, pt.size = 0.1) + NoLegend() 


##Checkpoint
save(pdac.integrated, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\pdac.integrated")
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 111672\\pdac.integrated")


p1 <- DimPlot(pdac.integrated, reduction="umap", group.by="orig.ident")
p2 <- DimPlot(pdac.integrated, reduction="umap", group.by="seurat_clusters")
p3 <- DimPlot(pdac.integrated, reduction="umap", group.by="orig_clusters", label=TRUE) + NoLegend()
p1 + p3

```



PDAC Integrated Heatmap Analysis

```{r}

pdac.integrated.meta.data <- pdac.integrated@meta.data
pdac1.meta.data <- pdac1@meta.data
pdac2.meta.data <- pdac2@meta.data

pdac1.meta.data$rownames <- rownames(pdac1.meta.data)
pdac1.meta.data$rownames <- paste0("Patient 1_", pdac1.meta.data$rownames)

pdac2.meta.data$rownames <- rownames(pdac2.meta.data)
pdac2.meta.data$rownames <- paste0("Patient 2_", pdac2.meta.data$rownames)
pdac2.meta.data$seurat_clusters <- as.factor(as.numeric(as.character(pdac2.meta.data$seurat_clusters)) + 12)

pdac.integrated.meta.data$rownames <- rownames(pdac.combined.meta.data)
integratetest1 <- merge(pdac.integrated.meta.data, pdac1.meta.data, by=c("rownames", "nCount_RNA"))
integratetest2 <- merge(pdac.integrated.meta.data, pdac2.meta.data, by=c("rownames", "nCount_RNA"))
pdac.integrated.merged <- rbind(integratetest1, integratetest2)

uniqueclusters1 <- as.matrix(unique(pdac.integrated.merged$seurat_clusters.x))
uniqueclusters2 <- as.matrix(unique(pdac.integrated.merged$seurat_clusters.y))

pdac.integrated.distribution.table <- dist_table(pdac.integrated.merged, uniqueclusters1, uniqueclusters2, 6, 12)

pdac.integrated.proportions.table <- prop_table(pdac.integrated.distribution.table, uniqueclusters1, uniqueclusters2)

uniqueclusters2 <- c("Acinar", "Cancer clone A", "Ductal 4", "Cancer clone B", "Ductal 3", "Ductal 1", "Ductal 2", "Tuft", "T & NK", "Endothelial", "Macrophages", "Endocrine & RBCs", "B_Acinar", "B_Cancer clone A", "B_Ductal 4", "B_Ductal 3", "B_Ductal 2", "B_Tuft & Endocrine", "B_Macrophages", "B_Ductal 1", "B_Endothelial")

pdac.integrated.comparison.heatmap <- ggplot_heatmap(pdac.integrated.proportions.table, uniqueclusters1, uniqueclusters2, xlab=c("Integrated Clustering"), ylab=c("Individual Clustering"))

pdac.integrated.comparison.heatmap

```



PDAC Gene Expression Analysis 

```{r}

Idents(pdac.integrated) <- pdac.integrated$seurat_clusters

pdac.integrated.vlnplot.PDCD1 <- VlnPlot(pdac.integrated, "PDCD1") + NoLegend()
pdac.integrated.vlnplot.CD274 <- VlnPlot(pdac.integrated, "CD274") + NoLegend()
pdac.integrated.vlnplot.PDCD1LG2 <- VlnPlot(pdac.integrated, "PDCD1LG2") + NoLegend()
pdac.integrated.vlnplot.TCF7 <- VlnPlot(pdac.integrated, "TCF7") + NoLegend()
pdac.integrated.vlnplot.PDCD1 + pdac.integrated.vlnplot.CD274 + pdac.integrated.vlnplot.PDCD1LG2 + pdac.integrated.vlnplot.TCF7



```



```{r}

pdac.integrated.treatment.barchart <- ggplot_barcharts(pdac.integrated@meta.data$orig.ident, pdac.integrated@meta.data$seurat_clusters, colors="Accent")
pdac.integrated.treatment.barchart


```


```{r}

set.seed(001)
pdac.subset <- SubsetData(pdac.integrated, max.cells.per.ident=100)
Idents(pdac.subset) = pdac.subset$orig.ident
pdac.averages <- AverageExpression(pdac.subset)
head(pdac.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),])

```




```{r}
features = c("IL7R", "CCR7", "S100A4", "CD14", "LYZ", "MS4A1", "CD8A", "FCGR3A", "MS4A7", "GNLY", "NKG7", "FCER1A", "CST3", "PPBP")
FeaturePlot(pdac.combined, features=features)
DotPlot(pdac.combined, features=features) + RotatedAxis()
RidgePlot(pdac.combined, features=features, ncol=6)
DoHeatmap(subset(pdac.combined, downsample=100), features=features)
```












##############################################################################################

Analyze GSE 155698 Dataset

```{r}

PDAC155698.1.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710689_PDAC_TISSUE_1\\PDAC_TISSUE_1\\filtered_feature_bc_matrix\\")
PDAC155698.2.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710690_PDAC_TISSUE_2\\PDAC_TISSUE_2\\filtered_feature_bc_matrix\\")
PDAC155698.3.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710691_PDAC_TISSUE_3\\PDAC_TISSUE_3\\filtered_feature_bc_matrix\\")
PDAC155698.4.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710692_PDAC_TISSUE_4\\PDAC_TISSUE_4\\filtered_feature_bc_matrix\\")
PDAC155698.5.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710693_PDAC_TISSUE_5\\PDAC_TISSUE_5\\filtered_feature_bc_matrix\\")
PDAC155698.6.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710694_PDAC_TISSUE_6\\PDAC_TISSUE_6\\filtered_feature_bc_matrix\\")
PDAC155698.7.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710695_PDAC_TISSUE_7\\PDAC_TISSUE_7\\filtered_feature_bc_matrix\\")
PDAC155698.8.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710696_PDAC_TISSUE_8\\PDAC_TISSUE_8\\filtered_feature_bc_matrix\\")
PDAC155698.9.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710697_PDAC_TISSUE_9\\PDAC_TISSUE_9\\filtered_feature_bc_matrix\\")
PDAC155698.10.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710698_PDAC_TISSUE_10\\PDAC_TISSUE_10\\filtered_feature_bc_matrix\\")
PDAC155698.11A.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710699_PDAC_TISSUE_11A\\PDAC_TISSUE_11A\\filtered_feature_bc_matrix\\")
PDAC155698.11B.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710700_PDAC_TISSUE_11B\\PDAC_TISSUE_11B\\filtered_feature_bc_matrix\\")
PDAC155698.12.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710701_PDAC_TISSUE_12\\PDAC_TISSUE_12\\filtered_feature_bc_matrix\\")
PDAC155698.13.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710702_PDAC_TISSUE_13\\PDAC_TISSUE_13\\filtered_feature_bc_matrix\\")
## PDAC155698.14.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710703_PDAC_TISSUE_14\\PDAC_TISSUE_14\\filtered_feature_bc_matrix\\")
PDAC155698.15.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710704_PDAC_TISSUE_15\\PDAC_TISSUE_15\\filtered_feature_bc_matrix\\")
PDAC155698.16.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC Samples\\GSM4710705_PDAC_TISSUE_16\\PDAC_TISSUE_16\\filtered_gene_bc_matrices\\")

## PDAC 14 file could not be opened 

PDAC155698.1 <- CreateSeuratObject(PDAC155698.1.read, project="PDAC155698.1", min.cells=3, min.features=200)
PDAC155698.2 <- CreateSeuratObject(PDAC155698.2.read, project="PDAC155698.2", min.cells=3, min.features=200)
PDAC155698.3 <- CreateSeuratObject(PDAC155698.3.read, project="PDAC155698.3", min.cells=3, min.features=200)
PDAC155698.4 <- CreateSeuratObject(PDAC155698.4.read, project="PDAC155698.4", min.cells=3, min.features=200)
PDAC155698.5 <- CreateSeuratObject(PDAC155698.5.read, project="PDAC155698.5", min.cells=3, min.features=200)
PDAC155698.6 <- CreateSeuratObject(PDAC155698.6.read, project="PDAC155698.6", min.cells=3, min.features=200)
PDAC155698.7 <- CreateSeuratObject(PDAC155698.7.read, project="PDAC155698.7", min.cells=3, min.features=200)
PDAC155698.8 <- CreateSeuratObject(PDAC155698.8.read, project="PDAC155698.8", min.cells=3, min.features=200)
PDAC155698.9 <- CreateSeuratObject(PDAC155698.9.read, project="PDAC155698.9", min.cells=3, min.features=200)
PDAC155698.10 <- CreateSeuratObject(PDAC155698.10.read, project="PDAC155698.10", min.cells=3, min.features=200)
PDAC155698.11A <- CreateSeuratObject(PDAC155698.11A.read, project="PDAC155698.11A", min.cells=3, min.features=200)
PDAC155698.11B <- CreateSeuratObject(PDAC155698.11B.read, project="PDAC155698.11B", min.cells=3, min.features=200)
PDAC155698.12 <- CreateSeuratObject(PDAC155698.12.read, project="PDAC155698.12", min.cells=3, min.features=200)
PDAC155698.13 <- CreateSeuratObject(PDAC155698.13.read, project="PDAC155698.13", min.cells=3, min.features=200)
## PDAC155698.14 <- CreateSeuratObject(PDAC155698.14.read, project="PDAC155698.14", min.cells=3, min.features=200)
PDAC155698.15 <- CreateSeuratObject(PDAC155698.15.read, project="PDAC155698.15", min.cells=3, min.features=200)
PDAC155698.16 <- CreateSeuratObject(PDAC155698.16.read, project="PDAC155698.16", min.cells=3, min.features=200)

## Merge datasets together

PDAC155698 <- merge(PDAC155698.1, y=c(PDAC155698.2, PDAC155698.3, PDAC155698.4, PDAC155698.5, PDAC155698.6, PDAC155698.7, PDAC155698.8, PDAC155698.9, PDAC155698.10, PDAC155698.11A, PDAC155698.11B, PDAC155698.12, PDAC155698.13, PDAC155698.15, PDAC155698.16), add.cell.ids = c("tissue1", "tissue2", "tissue3", "tissue4", "tissue5", "tissue6", "tissue7", "tissue8", "tissue9", "tissue10", "tissue11A", "tissue11B", "tissue12", "tissue13", "tissue15", "tissue16"), project="PDAC155698")


## Integrate datasets together

PDAC155698.list <- list(PDAC155698.1, PDAC155698.2, PDAC155698.3, PDAC155698.4, PDAC155698.5, PDAC155698.6, PDAC155698.7, PDAC155698.8, PDAC155698.9, PDAC155698.10, PDAC155698.11A, PDAC155698.11B, PDAC155698.12, PDAC155698.13, PDAC155698.15, PDAC155698.16)
PDAC155698.anchors <- FindIntegrationAnchors(object.list=PDAC155698.list, dims=1:50)
PDAC155698.integrated <- IntegrateData(anchorset=PDAC 155698.anchors, dims=1:50)
DefaultAssay(PDAC155698.integrated) <- "RNA"

```


Initial Analysis of GSE155698

```{r}
PDAC155698.integrated <- preprocessing(PDAC155698.integrated)

## Determine optimal resolution 
test_resolution(PDAC155698.integrated, 0.3)
test_resolution(PDAC155698.integrated, 0.4)
test_resolution(PDAC155698.integrated, 0.2)
test_resolution(PDAC155698.integrated, 0.5)
## Best resolution: 0.5 (27 clusters)

PDAC155698.integrated <- clustering(PDAC155698.integrated, resolution=0.5, genes=FALSE)

save(PDAC155698.integrated, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC155698.integrated")
memory.limit(size=160000000)
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC155698.integrated")

PDAC155698.integrated.umap <- DimPlot(PDAC155698.integrated, reduction="umap", label=TRUE)
PDAC155698.integrated.umap

```

Clustering Labels

```{r}

## Features taken from Figure 4B

FeaturePlot(PDAC155698.integrated, features=c('LAMP3', 'CCL22', 'TFF1', 'KRT18', 'KRT19', 'KRT8', 'CLU', 'MMP7', 'SPP1', 'REG1A', 'CTRB2', 'PRSS1', 'DCN', 'LUM', 'CPA3', 'TPSAB1', 'CDH5', 'VWF', 'PLVAP', 'IRF7', 'RGS5', 'PDGFRB', 'CD3E', 'NCAM1', 'NKG7', 'CD3D', 'CD14', 'HLA-DRA', 'GZMB', 'ITGAX', 'ITGAM', 'APOE', 'LYZ', 'IGJ', 'CD79A', 'MS4A1'))

labels <- c("0", "1", "Epithelial + Endocrine", "Macrophages", "Granulocytes", "Epithelial + Endocrine", "Dendritic", "Macrophages", "Epithelial + Endocrine", "Epithelial + Endocrine", "Fibroblasts", "Mast cells", "Macrophages", "Plasma cells", "Epithelial + Endocrine", "B cells", "Granulocytes", "Pericytes", "Acinar cells", "Epithelial + Endocrine", "20", "Acinar cells", "Epithelial + Endocrine", "Endothelial", "Macrophages", "Epithelial + Endocrine", "Plasma cells")

names(labels) <- levels(PDAC155698.integrated)
PDAC155698.integrated <- RenameIdents(PDAC155698.integrated, labels)
PDAC155698.integrated@meta.data$seurat_clusters <- PDAC155698.integrated@active.ident
DimPlot(PDAC155698.integrated, reduction="umap", label=TRUE, pt.size = 0.1) + NoLegend() 

## Separate T and NK cell types

PDAC155698.integrated.subset1 <- subset(PDAC155698.integrated, idents=c('0', '1', '20'))

PDAC155698.integrated.subset1 <- clustering(PDAC155698.integrated.subset1, resolution=1)
PDAC155698.integrated.subset1.umap <- DimPlot(PDAC155698.integrated.subset1, reduction="umap", label=TRUE)
PDAC155698.integrated.subset1.umap

FeaturePlot(PDAC155698.integrated.subset1, features=c("CD3E", "NCAM1", "NKG7", "CD3D", "FOXP3", "GZMB"))
labels <- c("CD4+ T cells", "Tregs", "CD4+ T cells", "CD8+ T cells", "CD8+ T cells", "CD8+ T cells", "NK cells", "CD4+ T cells", "NK cells", "CD8+ T cells", "Other", "CD4+ T cells", "CD8+ T cells", "CD8+ T cells")
names(labels) <- levels(PDAC155698.integrated.subset1)
PDAC155698.integrated.subset1 <- RenameIdents(PDAC155698.integrated.subset1, labels)

PDAC155698.integrated$sub_cluster <- as.character(Idents(PDAC155698.integrated))
PDAC155698.integrated$sub_cluster[Cells(PDAC155698.integrated.subset1)] <- paste(Idents(PDAC155698.integrated.subset1))
DimPlot(PDAC155698.integrated, group.by="sub_cluster", label = TRUE)

PDAC155698.integrated$seurat_clusters <- PDAC155698.integrated$sub_cluster
Idents(PDAC155698.integrated) <- PDAC155698.integrated$seurat_clusters

PDAC155698.integrated <- RenameIdents(PDAC155698.integrated, 'Other' = 'Macrophages')
PDAC155698.integrated.umap <- DimPlot(PDAC155698.integrated, reduction="umap", label=TRUE)
PDAC155698.integrated.umap

## Checkpoint

save(PDAC155698.integrated, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC155698.integrated")
memory.limit(size=160000000)
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\PDAC155698.integrated")

PDAC155698.integrated.umap <- DimPlot(PDAC155698.integrated, reduction="umap", label=TRUE) + NoLegend()
PDAC155698.integrated.umap

```


Distribution of samples in integrated clustering

```{r}

PDAC155698.tissue.umap <- DimPlot(PDAC155698.integrated, reduction="umap", group.by="orig.ident")
PDAC155698.tissue.umap

PDAC155698.tissue.barchart <- ggplot_barcharts(PDAC155698.integrated@meta.data$orig.ident, PDAC155698.integrated@meta.data$seurat_clusters, colors="Accent")
PDAC155698.tissue.barchart

```


GSE155698 Healthy Pancreas Samples

```{r}

## Read datasets

PDAC155698.H1.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\Healthy Samples\\GSM4710726_Healthy_PBMC_1\\Healthy_PBMC_1\\filtered_feature_bc_matrix")
PDAC155698.H2.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\Healthy Samples\\GSM4710727_Healthy_PBMC_2\\Healthy_PBMC_2\\filtered_feature_bc_matrix")
PDAC155698.H3.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\Healthy Samples\\GSM4710728_Healthy_PBMC_3\\Healthy_PBMC_3\\filtered_feature_bc_matrix")
PDAC155698.H4.read <- Read10X("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 155698\\Healthy Samples\\GSM4710729_Healthy_PBMC_4\\Healthy_PBMC_4\\filtered_feature_bc_matrix")

## Create Seurat objects

PDAC155698.H1 <- CreateSeuratObject(PDAC155698.H1.read, project="PDAC155698.H1", min.cells=3, min.features=200)
PDAC155698.H2 <- CreateSeuratObject(PDAC155698.H2.read, project="PDAC155698.H2", min.cells=3, min.features=200)
PDAC155698.H3 <- CreateSeuratObject(PDAC155698.H3.read, project="PDAC155698.H3", min.cells=3, min.features=200)
PDAC155698.H4 <- CreateSeuratObject(PDAC155698.H4.read, project="PDAC155698.H4", min.cells=3, min.features=200)

## Integrate datasets

PDAC155698.all.list <- list(PDAC155698.1, PDAC155698.2, PDAC155698.3, PDAC155698.4, PDAC155698.5, PDAC155698.6, PDAC155698.7, PDAC155698.8, PDAC155698.9, PDAC155698.10, PDAC155698.11A, PDAC155698.11B, PDAC155698.12, PDAC155698.13, PDAC155698.15, PDAC155698.16, PDAC155698.H1, PDAC155698.H2, PDAC155698.H3, PDAC155698.H4)
PDAC155698.all.anchors <- FindIntegrationAnchors(object.list=PDAC155698.all.list, dims=1:50)
PDAC155698.all <- IntegrateData(anchorset=PDAC155698.all.anchors, dims=1:50)
DefaultAssay(PDAC155698.all) <- "RNA"

## Preprocessing

PDAC155698.all <- preprocessing(PDAC155698.all)
PDAC155698.all <- clustering(PDAC155698.all)

```