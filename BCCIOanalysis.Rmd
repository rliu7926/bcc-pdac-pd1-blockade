---
title: "BCCIO Analysis"
output:
  pdf_document: default
  html_notebook: default
---

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. `

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

```{r}
## Load packages
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
library(cowplot)
library(pracma)
library(RColorBrewer)
library(gridExtra)
library(EnhancedVolcano)
library(ggpubr)
library(CellChat)
library(grid)

## Load functions
source("ClusteringAnalysisFunctions.R", echo=TRUE)
source("SeuratClusteringFunctions.R", echo=TRUE)

## Load subsetteed data
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCresponderpre")
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCresponderpost")

load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCnonresponderpre")
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCnonresponderpost")

## Load BCC object
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCIOwithUMAP")

```


Read data from GSE123813 (pape: clonal replacement of tumor-specific T cells following PD-1 blockade)
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE123813

```{r}
## Read data
BCCIO.read <- read.table("C:\\Users\\Ryan\\Downloads\\GSE 123813\\bcc_scRNA_counts.txt", row.names = 1, sep="\t", as.is=T)

## Read metadata
BCCIO.meta.data.readall <- read.table("C:\\Users\\Ryan\\Downloads\\GSE 123813\\bcc_all_metadata.txt", row.names = 1, sep="\t", as.is=T)

## Format metadata
BCCIO.meta.data.read_colnamesall <- BCCIO.meta.data.readall[1,] # Store column names 

BCCIO.meta.data <- BCCIO.meta.data.readall[2:nrow(BCCIO.meta.data.readall),] # Get rid of column names (first row)

names(BCCIO.meta.data) <- BCCIO.meta.data.read_colnamesall # Change the column names
```


Create Seurat object

```{r}
memory.limit(size = 16000000) #Increase memory limit for vector sizes 
BCCIO <- CreateSeuratObject(counts = BCCIO.read, project = "BCCIO", min.cells = 3, min.features = 200, meta.data = BCCIO.meta.data)
```


Pre-processing workflow

```{r}

BCCIO <- NormalizeData(BCCIO, normalization.method= "LogNormalize", scale.factor = 10000) # Normalize feature expression 

BCCIO <- FindVariableFeatures(BCCIO, selection.method = "vst", nfeatures = 2000) # Feature selection (highly variable features)

all.genes <- rownames(BCCIO)
BCCIO <- ScaleData(BCCIO, features = all.genes) # Scale data in preparation for PCA 
BCCIO <- RunPCA(BCCIO, features = VariableFeatures(object = BCCIO)) # Perform PCA
```


Checkpoint (Save Work Here)

```{r}

save(BCCIO, file="C:\\Users\\Ryan\\Downloads\\GSE 123813\\BCCIO")
save(BCCIO.meta.data,BCCIO.read, file = "C:\\Users\\Ryan\\Downloads\\GSE 123813\\BCCIOrawdata")

## To load data use load(filelocation) function
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCIO")
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCIOrawdata")
```


Elbow Plot (Determine # of PCs to consider)

```{r}

ElbowPlot(BCCIO, ndims=50)
DimHeatmap(BCCIO, dims = 1:24, cells = 500, balanced = TRUE)

```


Test out Clustering (Varying Resolution Levels)
Higher resolution = greater clustering

```{r}

BCCIO <- FindNeighbors(BCCIO, dims = 1:15)

## Start with r = 0.3 (overclustered)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.2 (overclustered)

BCCIO <- FindClusters(BCCIO, resolution = 0.2, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.1 (overclustered)

BCCIO <- FindClusters(BCCIO, resolution = 0.1, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.05 (looks okay)

BCCIO <- FindClusters(BCCIO, resolution = 0.05, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)


## Try r = 0.03 (around the same as 0.05)

BCCIO <- FindClusters(BCCIO, resolution = 0.04, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.3, bimod test (identical to wilcox)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'bimod', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.3, roc test (error)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'roc', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.3, t test (identical to wilcox)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 't', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.3, LR test (identical to wilcox)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'LR', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Start with r = 0.4

BCCIO <- FindClusters(BCCIO, resolution = 0.4, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 200)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

```

Full DE Testing (UMAP) for r=0.4, test=wilcox

```{r}

BCCIO <- FindNeighbors(BCCIO, dims = 1:50)
BCCIO <- FindClusters(BCCIO, resolution = 0.4, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.25, max.cells.per.ident = 500) ## Run through all cells
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_log2FC)
DoHeatmap(BCCIO,features = top5$gene, size = 3) ## Heatmap with all cells

top25 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=25, wt=avg_logFC)
BCCIO.top25genes <- top25[c(6,7)]

BCCIO.top2genes <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=2, wt=avg_logFC)
BCCIO.geneslist <- unique(unlist(top2[7]))

BCCIO <- RunUMAP(BCCIO, dims = 1:50)
DimPlot(BCCIO, reduction="umap", label=TRUE, pt.size = 0.1) + NoLegend() 

## New Labels
labels <- c("CD8_memory", "CD4", "B cells", "Tregs", "CD8_activation", "CD8_exhausted", "Macrophages", "Plasma", "Tumor 1", "Misc.", "T_proliferation", "CAFs", "CD8_exhausted", "NK", "pDCs", "Tumor 2", "Tumor 1", "Misc.", "Plasma", "Endothelial", "DCs", "Macrophages", "Misc.", "Myofibroblasts", "Tumor 2", "Misc.", "Plasma", "Melanocytes", "Melanocytes")

Idents(BCCIO) <- BCCIO$seurat_clusters
names(labels) <- levels(BCCIO)
BCCIO <- RenameIdents(BCCIO, labels)
BCCIO@meta.data$seurat_clusters <- BCCIO@active.ident
DimPlot(BCCIO, reduction="umap", label=TRUE, pt.size = 0.1) + NoLegend() 

## Checkpoint
save(BCCIO, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCIOwithUMAP")

## To load: 
memory.limit(size = 16000000) 
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCIOwithUMAP")

```

Clustering comparison heatmap

```{r}

BCCIO.meta.data1 <- BCCIO.meta.data[order(BCCIO.meta.data[, "sort"], -xtfrm(BCCIO.meta.data[, "treatment"])),]
BCCIO.meta.data2 <- BCCIO@meta.data[order(BCCIO@meta.data[, "sort"]),]

BCCIO.meta.data1["rownames"] <- rownames(BCCIO.meta.data1)
BCCIO.meta.data2["rownames"] <- rownames(BCCIO.meta.data2)

BCCIO.meta.data.merge <- merge(BCCIO.meta.data1, BCCIO.meta.data2, by.x=c("rownames"), by.y=c("rownames"))
BCCIO.clustering.comparison <- BCCIO.meta.data.merge[c("cluster", "seurat_clusters")]

uniqueclusters1 <- as.matrix(unique(BCCIO.clustering.comparison[,1]))
uniqueclusters2 <- as.matrix(unique(BCCIO.clustering.comparison[,2]))

BCCIO.distribution.table <- dist_table(BCCIO.clustering.comparison, uniqueclusters1, uniqueclusters2, 1, 2)

BCCIO.proportion.table <- prop_table(BCCIO.distribution.table, uniqueclusters1, uniqueclusters2)

BCCIO.heatmap <- ggplot_heatmap(BCCIO.proportion.table, uniqueclusters1, uniqueclusters2, c("Spectral"), c("Metadata Clustering"), c("My Clustering"))

BCCIO.heatmap

## Checkpoint
save(BCCIO.heatmap, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCIOheatmap")
## To load: 
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCIOheatmap")

```



Comparison of Pre- and Post-Treatment

```{r}

DimPlot(BCCIO, reduction="umap", split.by="treatment")

DimPlot(BCCIO, reduction="umap", split.by="patient")

BCCIO.treatment.barchart <- ggplot_barcharts(BCCIO@meta.data$treatment, BCCIO@meta.data$seurat_clusters, colors="PuBu")
BCCIO.treatment.barchart

BCCIO.patient.barchart <- ggplot_barcharts(BCCIO@meta.data$patient, BCCIO@meta.data$seurat_clusters, colors="Spectral")
BCCIO.patient.barchart

## Pre vs. post divided by patient 
Idents(BCCIO) <- BCCIO$treatment
BCCIO.pre <- subset(BCCIO, idents=c("pre"))
BCCIO.post <- subset(BCCIO, idents=c("post"))

BCCIO.pre.patient.barchart <- ggplot_barcharts(BCCIO.pre@meta.data$patient, BCCIO.pre@meta.data$seurat_clusters, colors="Spectral")
BCCIO.post.patient.barchart <- ggplot_barcharts(BCCIO.post@meta.data$patient, BCCIO.post@meta.data$seurat_clusters, colors="Spectral")
BCCIO.pre.patient.barchart + BCCIO.post.patient.barchart

## Patient divided by pre vs. post
Idents(BCCIO) <- BCCIO$patient
BCCIO.su001 <- subset(BCCIO, idents=c("su001"))
BCCIO.su002 <- subset(BCCIO, idents=c("su002"))
BCCIO.su003 <- subset(BCCIO, idents=c("su003"))
BCCIO.su004 <- subset(BCCIO, idents=c("su004"))
BCCIO.su005 <- subset(BCCIO, idents=c("su005"))
BCCIO.su006 <- subset(BCCIO, idents=c("su006"))
BCCIO.su007 <- subset(BCCIO, idents=c("su007"))
BCCIO.su008 <- subset(BCCIO, idents=c("su008"))
BCCIO.su009 <- subset(BCCIO, idents=c("su009"))
BCCIO.su010 <- subset(BCCIO, idents=c("su010"))
BCCIO.su012 <- subset(BCCIO, idents=c("su012"))

## Responders are su001, su002, su003, su004, su009, su012
## Nonresponders are su005, su006, su007, su008, su010

BCCIO.su001.treatment.barchart <- ggplot_barcharts(BCCIO.su001@meta.data$treatment, BCCIO.su001@meta.data$seurat_clusters, colors="Paired") + NoLegend()
BCCIO.su002.treatment.barchart <- ggplot_barcharts(BCCIO.su002@meta.data$treatment, BCCIO.su002@meta.data$seurat_clusters, colors="Paired") + NoLegend()
BCCIO.su003.treatment.barchart <- ggplot_barcharts(BCCIO.su003@meta.data$treatment, BCCIO.su003@meta.data$seurat_clusters, colors="Paired") + NoLegend()
BCCIO.su004.treatment.barchart <- ggplot_barcharts(BCCIO.su004@meta.data$treatment, BCCIO.su004@meta.data$seurat_clusters, colors="Paired") + NoLegend()
BCCIO.su005.treatment.barchart <- ggplot_barcharts(BCCIO.su005@meta.data$treatment, BCCIO.su005@meta.data$seurat_clusters, colors="Set3") + NoLegend()
BCCIO.su006.treatment.barchart <- ggplot_barcharts(BCCIO.su006@meta.data$treatment, BCCIO.su006@meta.data$seurat_clusters, colors="Set3") + NoLegend()
BCCIO.su007.treatment.barchart <- ggplot_barcharts(BCCIO.su007@meta.data$treatment, BCCIO.su007@meta.data$seurat_clusters, colors="Set3") + NoLegend()
BCCIO.su008.treatment.barchart <- ggplot_barcharts(BCCIO.su008@meta.data$treatment, BCCIO.su008@meta.data$seurat_clusters, colors="Set3") + NoLegend()
BCCIO.su009.treatment.barchart <- ggplot_barcharts(BCCIO.su009@meta.data$treatment, BCCIO.su009@meta.data$seurat_clusters, colors="Paired") + NoLegend()
BCCIO.su010.treatment.barchart <- ggplot_barcharts(BCCIO.su010@meta.data$treatment, BCCIO.su010@meta.data$seurat_clusters, colors="Set3") + NoLegend()
BCCIO.su012.treatment.barchart <- ggplot_barcharts(BCCIO.su012@meta.data$treatment, BCCIO.su012@meta.data$seurat_clusters, colors="Paired") + NoLegend()

grid.arrange(BCCIO.su001.treatment.barchart, BCCIO.su002.treatment.barchart, BCCIO.su003.treatment.barchart, BCCIO.su004.treatment.barchart, BCCIO.su005.treatment.barchart, BCCIO.su006.treatment.barchart, BCCIO.su007.treatment.barchart, BCCIO.su008.treatment.barchart, BCCIO.su009.treatment.barchart, BCCIO.su010.treatment.barchart, BCCIO.su012.treatment.barchart, nrow=3)

## Responders vs. Nonresponders

BCCIO.responders <- subset(BCCIO, idents=c("su001", "su002", "su003", "su004", "su009", "su012"))
BCCIO.nonresponders <- subset(BCCIO, idents=c("su005", "su006", "su007", "su008", "su010"))

BCCIO.responders.treatment.barchart <- ggplot_barcharts(BCCIO.responders@meta.data$treatment, BCCIO.responders@meta.data$seurat_clusters, colors="Paired") + NoLegend()
BCCIO.nonresponders.treatment.barchart <- ggplot_barcharts(BCCIO.nonresponders@meta.data$treatment, BCCIO.nonresponders@meta.data$seurat_clusters, colors="Set3") + NoLegend()

BCCIO.responders.treatment.barchart + BCCIO.nonresponders.treatment.barchart

```


Gene investigation 

```{r}
Idents(BCCIO) <- BCCIO$seurat_clusters

BCCIO.vlnplot.PDCD1 <- VlnPlot(BCCIO, "PDCD1")

Idents(BCCIO.pre) <- BCCIO.pre$seurat_clusters
Idents(BCCIO.post) <- BCCIO.post$seurat_clusters

FeaturePlot(BCCIO, features=c("TCF7", "PDCD1", "CD274", "PDCD1LG2"))

## PD1 protein
Idents(BCCIO.pre) <- BCCIO.pre$seurat_clusters
Idents(BCCIO.post) <- BCCIO.post$seurat_clusters
BCCIO.pre.vlnplot.PDCD1 <- VlnPlot(BCCIO.pre, "PDCD1", pt.size = 0) + NoLegend()
BCCIO.post.vlnplot.PDCD1 <- VlnPlot(BCCIO.post, "PDCD1", pt.size = 0) + NoLegend()
BCCIO.pre.vlnplot.PDCD1 + BCCIO.post.vlnplot.PDCD1

## PD-L1 protein
BCCIO.pre.vlnplot.CD274 <- VlnPlot(BCCIO.pre, "CD274", pt.size = 0) + NoLegend()
BCCIO.post.vlnplot.CD274 <- VlnPlot(BCCIO.post, "CD274", pt.size = 0) + NoLegend()
BCCIO.pre.vlnplot.CD274 + BCCIO.post.vlnplot.CD274

## PD-L2 protein 
BCCIO.pre.vlnplot.PDCD1LG2 <- VlnPlot(BCCIO.pre, "PDCD1LG2", pt.size = 0) + NoLegend()
BCCIO.post.vlnplot.PDCD1LG2 <- VlnPlot(BCCIO.post, "PDCD1LG2", pt.size = 0) + NoLegend()
BCCIO.pre.vlnplot.PDCD1LG2 + BCCIO.post.vlnplot.PDCD1LG2

## TCF7 protein
BCCIO.pre.vlnplot.TCF7 <- VlnPlot(BCCIO.pre, "TCF7", pt.size = 0) + NoLegend()
BCCIO.post.vlnplot.TCF7 <- VlnPlot(BCCIO.post, "TCF7", pt.size= 0) + NoLegend()
BCCIO.pre.vlnplot.TCF7 + BCCIO.post.vlnplot.TCF7

## DE pre vs. post 
Idents(BCCIO) <- BCCIO$treatment
BCCIO.DE.pre.markers <- FindMarkers(BCCIO, ident.1 = "pre", ident.2 = "post", only.pos=TRUE)
head(BCCIO.DE.pre.markers)
BCCIO.DE.post.markers <- FindMarkers(BCCIO, ident.1 = "post", ident.2 = "pre", only.pos=TRUE)
head(BCCIO.DE.post.markers)

## DE pre vs. post on Dendritic cells only
Idents(BCCIO) <- BCCIO$seurat_clusters
BCCIO.DCs <- subset(BCCIO, idents=c("DCs"))

Idents(BCCIO.DCs) <- BCCIO.DCs$treatment

BCCIO.DCs.DE.pre.markers <- FindMarkers(BCCIO.DCs, ident.1="pre", ident.2="post", only.pos=TRUE)
head(BCCIO.DCs.DE.pre.markers)
BCCIO.DCs.DE.post.markers <- FindMarkers(BCCIO.DCs, ident.1="post", ident.2="pre", only.pos=TRUE)
head(BCCIO.DCs.DE.post.markers)

## DE pre vs. post on T cells only
Idents(BCCIO) <- BCCIO$seurat_clusters
BCCIO.CD8 <- subset(BCCIO, idents=c("CD8_activation", "CD8_memory", "CD8_exhausted"))

Idents(BCCIO.CD8) <- BCCIO.CD8$treatment
DimPlot(BCCIO.CD8, reduction="umap", label=TRUE, pt.size = 0.1) + NoLegend() 

Idents(BCCIO.CD8) <- BCCIO.CD8$seurat_clusters
BCCIO.CD8.markers <- FindAllMarkers(BCCIO.CD8, only.pos=TRUE, min.pct=0.25, logfc.threshold=0.25)
BCCIO.CD8.markers %>% group_by(cluster) %>% top_n(n=20, wt=avg_logFC)
FeaturePlot(BCCIO.CD8, features=c("TCF7", "PDCD1", "CD274", "PDCD1LG2"))

```



Average gene expression 

```{r}

set.seed(001)
bcc.subset <- BCCIO[, sample(colnames(BCCIO), size = 5000)]

Idents(bcc.subset) <- bcc.subset$treatment
bcc.treatment.averages <- AverageExpression(bcc.subset)
head(bcc.treatment.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),])

Idents(bcc.subset) <- bcc.subset$patient
bcc.patient.averages <- AverageExpression(bcc.subset)
bcc.patient.averages.pd1 <- bcc.patient.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),]
View(bcc.patient.averages.pd1)

Idents(bcc.subset) <- bcc.subset$response
bcc.response.averages <- AverageExpression(bcc.subset)
bcc.response.averages.pd1 <- bcc.response.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),]
View(bcc.response.averages.pd1)

## Determine if differences are significant

bcc.pd1.averages <- head(bcc.patient.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),])
bcc.pd1.averages <- as.data.frame(t(bcc.pd1.averages))

bcc.pd1.averages$Response <- NULL
bcc.pd1.averages$Response <- c("Responsive", "Responsive", "Responsive", "Responsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Responsive", "Nonresponsive", "Responsive")

bcc.pd1.comparison <- ggboxplot(bcc.pd1.averages, x = "Response", y = "PDCD1", color = "Response", palette = c("Red", "Blue"), add = "jitter") + 
  stat_compare_means(method = "anova")
bcc.pdl1.comparison <- ggboxplot(bcc.pd1.averages, x = "Response", y = "CD274", color = "Response", palette = c("Red", "Blue"), add = "jitter") + 
  stat_compare_means(method = "anova")
bcc.pdl2.comparison <- ggboxplot(bcc.pd1.averages, x = "Response", y = "PDCD1LG2", color = "Response", palette = c("Red", "Blue"), add = "jitter") + 
  stat_compare_means(method = "anova")
bcc.tcf7.comparison <- ggboxplot(bcc.pd1.averages, x = "Response", y = "TCF7", color = "Response", palette = c("Red", "Blue"), add = "jitter") + 
  stat_compare_means(method = "anova")

grid.arrange(bcc.pd1.comparison, bcc.pdl1.comparison, bcc.pdl2.comparison, bcc.tcf7.comparison, ncol=4)

```



Average gene expression divided by celltype

```{r}

levels(Idents(BCCIO)) <- BCCIO$seurat_clusters

## Cell populations of interest: T cells, B cells, malignant cells, macrophages

bcc.tcells <- subset(BCCIO, idents=c("CD8_memory", "CD4", "Tregs", "CD8_activation", "CD8_exhausted", "T_proliferation"))
bcc.bcells <- subset(BCCIO, idents=c("B cells"))
bcc.tumor <- subset(BCCIO, idents=c("Tumor 1", "Tumor 2"))
bcc.macrophages <- subset(BCCIO, idents=c("Macrophages"))

Idents(bcc.tcells) <- bcc.tcells$patient
bcc.tcells.averages <- AverageExpression(bcc.tcells)
bcc.tcells.pd1.averages <- bcc.tcells.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),]

Idents(bcc.bcells) <- bcc.bcells$patient
bcc.bcells.averages <- AverageExpression(bcc.bcells)
bcc.bcells.pd1.averages <- bcc.bcells.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),]

Idents(bcc.tumor) <- bcc.tumor$patient
bcc.tumor.averages <- AverageExpression(bcc.tumor)
bcc.tumor.pd1.averages <- bcc.tumor.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),]

Idents(bcc.macrophages) <- bcc.macrophages$patient
bcc.macrophages.averages <- AverageExpression(bcc.macrophages)
bcc.macrophages.pd1.averages <- bcc.macrophages.averages[["RNA"]][c("TCF7", "PDCD1", "CD274", "PDCD1LG2"),]

bcc.tcells.pd1.averages <- as.data.frame(t(bcc.tcells.pd1.averages))
bcc.bcells.pd1.averages <- as.data.frame(t(bcc.bcells.pd1.averages))
bcc.tumor.pd1.averages <- as.data.frame(t(bcc.tumor.pd1.averages))
bcc.macrophages.pd1.averages <- as.data.frame(t(bcc.macrophages.pd1.averages))


bcc.tcells.pd1.averages$Patients <- c("Responsive", "Responsive", "Responsive", "Responsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Responsive", "Nonresponsive", "Responsive")
bcc.bcells.pd1.averages$Patients <- c("Responsive", "Responsive", "Responsive", "Responsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Nonresponsive")
bcc.tumor.pd1.averages$Patients <- c("Responsive", "Responsive", "Responsive", "Responsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Nonresponsive")
bcc.macrophages.pd1.averages$Patients <- c("Responsive", "Responsive", "Responsive", "Responsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Nonresponsive", "Responsive", "Responsive")

bcc.tcells.pd1.averages$Patient.ID <- rownames(bcc.tcells.pd1.averages)
bcc.bcells.pd1.averages$Patient.ID <- rownames(bcc.bcells.pd1.averages)
bcc.tumor.pd1.averages$Patient.ID <- rownames(bcc.tumor.pd1.averages)
bcc.macrophages.pd1.averages$Patient.ID <- rownames(bcc.macrophages.pd1.averages)

bcc.tcells.pd1.averages.test <- melt(bcc.tcells.pd1.averages, id.vars = c("Patient.ID", "Patients"), measure.vars = c("PDCD1", "CD274", "PDCD1LG2", "TCF7"))

bcc.tcells.pd1.comparison <- ggboxplot(bcc.tcells.pd1.averages, x = "Patients", y = "PDCD1", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.tcells.pdl1.comparison <- ggboxplot(bcc.tcells.pd1.averages, x = "Patients", y = "CD274", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.tcells.pdl2.comparison <- ggboxplot(bcc.tcells.pd1.averages, x = "Patients", y = "PDCD1LG2", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.tcells.tcf7.comparison <- ggboxplot(bcc.tcells.pd1.averages, x = "Patients", y = "TCF7", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")

bcc.bcells.pd1.comparison <- ggboxplot(bcc.bcells.pd1.averages, x = "Patients", y = "PDCD1", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.bcells.pdl1.comparison <- ggboxplot(bcc.bcells.pd1.averages, x = "Patients", y = "CD274", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.bcells.pdl2.comparison <- ggboxplot(bcc.bcells.pd1.averages, x = "Patients", y = "PDCD1LG2", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.bcells.tcf7.comparison <- ggboxplot(bcc.bcells.pd1.averages, x = "Patients", y = "TCF7", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")

bcc.tumor.pd1.comparison <- ggboxplot(bcc.tumor.pd1.averages, x = "Patients", y = "PDCD1", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.tumor.pdl1.comparison <- ggboxplot(bcc.tumor.pd1.averages, x = "Patients", y = "CD274", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.tumor.pdl2.comparison <- ggboxplot(bcc.tumor.pd1.averages, x = "Patients", y = "PDCD1LG2", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.tumor.tcf7.comparison <- ggboxplot(bcc.tumor.pd1.averages, x = "Patients", y = "TCF7", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")

bcc.macrophages.pd1.comparison <- ggboxplot(bcc.macrophages.pd1.averages, x = "Patients", y = "PDCD1", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.macrophages.pdl1.comparison <- ggboxplot(bcc.macrophages.pd1.averages, x = "Patients", y = "CD274", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.macrophages.pdl2.comparison <- ggboxplot(bcc.macrophages.pd1.averages, x = "Patients", y = "PDCD1LG2", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")
bcc.macrophages.tcf7.comparison <- ggboxplot(bcc.macrophages.pd1.averages, x = "Patients", y = "TCF7", color = "Patients", palette = c("Red", "Blue"), add = "jitter") + stat_compare_means(method = "t.test")

grid.arrange(bcc.tcells.pd1.comparison, bcc.tcells.pdl1.comparison, bcc.tcells.pdl2.comparison, bcc.tcells.tcf7.comparison, ncol=4, top = "T Cells")

```





##################################################################################################################################

Examine differences between pretreatment and posttreatment of responders and nonresponders

Create objects

```{r}

Idents(BCCIO) <- BCCIO$response

BCC.responder <- subset(BCCIO, idents="Responsive")
BCC.nonresponder <- subset(BCCIO, idents="Nonresponsive")

remove(BCCIO)

Idents(BCC.responder) <- BCC.responder$treatment
Idents(BCC.nonresponder) <- BCC.nonresponder$treatment
  
BCC.responder.pre <- subset(BCC.responder, idents="pre")
BCC.responder.post <- subset(BCC.responder, idents="post")

remove(BCC.responder)

BCC.nonresponder.pre <- subset(BCC.nonresponder, idents="pre")
BCC.nonresponder.post <- subset(BCC.nonresponder, idents="post")

remove(BCC.nonresponder)

save(BCC.responder.pre, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCresponderpre")
save(BCC.responder.post, file-"C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCresponderpost")

save(BCC.nonresponder.pre, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCrnonesponderpre")
save(BCC.nonresponder.post, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCnonresponderpost")
```



Comparison of BCC Responder vs. Nonresponder, Pretreatment vs. Posttreatment for all cells 

```{r}

## Set idents to analyze by patient

Idents(BCC.responder.pre) <- BCC.responder.pre$patient
Idents(BCC.responder.post) <- BCC.responder.post$patient

Idents(BCC.nonresponder.pre) <- BCC.nonresponder.pre$patient
Idents(BCC.nonresponder.post) <- BCC.nonresponder.post$patient

## Determine average expression of genes

BCC.responder.pre.averages <- AverageExpression(BCC.responder.pre)
BCC.responder.post.averages <- AverageExpression(BCC.responder.post)
BCC.nonresponder.pre.averages <- AverageExpression(BCC.nonresponder.pre)
BCC.nonresponder.post.averages <- AverageExpression(BCC.nonresponder.post)

BCC.responder.pre.averages <- BCC.responder.pre.averages$RNA
BCC.responder.post.averages <- BCC.responder.post.averages$RNA
BCC.nonresponder.pre.averages <- BCC.nonresponder.pre.averages$RNA
BCC.nonresponder.post.averages <- BCC.nonresponder.post.averages$RNA

## Filter out important genes

MHC1.genes <- c('HLA-A', 'HLA-B', 'HLA-C', 'HLA-E', 'HLA-F', 'HLA-G')
MHC2.genes <- c('HLA-DMA', 'HLA-DMB', 'HLA-DOA', 'HLA-DOB', 'HLA-DPA1', 'HLA-DPB1', 'HLA-DQA1', 'HLA-DQA2', 'HLA-DQB1', 'HLA-DQB1-AS1', 'HLA-DQB2', 'HLA-DRA', 'HLA-DRB1', 'HLA-DRB5')
HSP.genes <- c('HSP90AA1', 'HSP90AB1', 'HSP90B1', 'HPSA12A', 'HSPA12B', 'HSPA13', 'HSPA14', 'HPSA1A', 'HSPA1B', 'HSPA1L', 'HSPA2', 'HSPA4', 'HSPA4L', 'HSPA5', 'HSPA6', 'HSPA8', 'HSPA9', 'HSPB1', 'HSPB11', 'HSPB2', 'HSPB3', 'HSPB6', 'HSPB7', 'HSPB8', 'HSPB9', 'HSPBAP1', 'HSPBP1', 'HSPD1', 'HSPE1', 'HSPE1-MOB4', 'HSPG2', 'HSPH1')

BCC.responder.pre.averages.mhc1 <- BCC.responder.pre.averages[MHC1.genes,]
BCC.responder.pre.averages.mhc2 <- BCC.responder.pre.averages[MHC2.genes,]
BCC.responder.pre.averages.hsp <- BCC.responder.pre.averages[HSP.genes,]

BCC.responder.post.averages.mhc1 <- BCC.responder.post.averages[MHC1.genes,]
BCC.responder.post.averages.mhc2 <- BCC.responder.post.averages[MHC2.genes,]
BCC.responder.post.averages.hsp <- BCC.responder.post.averages[HSP.genes,]

BCC.nonresponder.pre.averages.mhc1 <- BCC.nonresponder.pre.averages[MHC1.genes,]
BCC.nonresponder.pre.averages.mhc2 <- BCC.nonresponder.pre.averages[MHC2.genes,]
BCC.nonresponder.pre.averages.hsp <- BCC.nonresponder.pre.averages[HSP.genes,]

BCC.nonresponder.post.averages.mhc1 <- BCC.nonresponder.post.averages[MHC1.genes,]
BCC.nonresponder.post.averages.mhc2 <- BCC.nonresponder.post.averages[MHC2.genes,]
BCC.nonresponder.post.averages.hsp <- BCC.nonresponder.post.averages[HSP.genes,]

## Calculate scores (arithmetic mean)

BCC.responder.pre.averages.mhc1$gene <- NULL
BCC.responder.pre.averages.mhc2$gene <- NULL
BCC.responder.pre.averages.hsp$gene <- NULL

BCC.responder.post.averages.mhc1$gene <- NULL
BCC.responder.post.averages.mhc2$gene <- NULL
BCC.responder.post.averages.hsp$gene <- NULL

BCC.nonresponder.pre.averages.mhc1$gene <- NULL
BCC.nonresponder.pre.averages.mhc2$gene <- NULL
BCC.nonresponder.pre.averages.hsp$gene <- NULL

BCC.nonresponder.post.averages.mhc1$gene <- NULL
BCC.nonresponder.post.averages.mhc2$gene <- NULL
BCC.nonresponder.post.averages.hsp$gene <- NULL

BCC.responder.pre.averages.mhc1.score <- as.data.frame(colMeans(BCC.responder.pre.averages.mhc1, na.rm=TRUE))
BCC.responder.pre.averages.mhc2.score <- as.data.frame(colMeans(BCC.responder.pre.averages.mhc2, na.rm=TRUE))
BCC.responder.pre.averages.hsp.score <- as.data.frame(colMeans(BCC.responder.pre.averages.hsp, na.rm=TRUE))

BCC.responder.post.averages.mhc1.score <- as.data.frame(colMeans(BCC.responder.post.averages.mhc1, na.rm=TRUE))
BCC.responder.post.averages.mhc2.score <- as.data.frame(colMeans(BCC.responder.post.averages.mhc2, na.rm=TRUE))
BCC.responder.post.averages.hsp.score <- as.data.frame(colMeans(BCC.responder.post.averages.hsp, na.rm=TRUE))

BCC.nonresponder.pre.averages.mhc1.score <- as.data.frame(colMeans(BCC.nonresponder.pre.averages.mhc1, na.rm=TRUE))
BCC.nonresponder.pre.averages.mhc2.score <- as.data.frame(colMeans(BCC.nonresponder.pre.averages.mhc2, na.rm=TRUE))
BCC.nonresponder.pre.averages.hsp.score <- as.data.frame(colMeans(BCC.nonresponder.pre.averages.hsp, na.rm=TRUE))

BCC.nonresponder.post.averages.mhc1.score <- as.data.frame(colMeans(BCC.nonresponder.post.averages.mhc1, na.rm=TRUE))
BCC.nonresponder.post.averages.mhc2.score <- as.data.frame(colMeans(BCC.nonresponder.post.averages.mhc2, na.rm=TRUE))
BCC.nonresponder.post.averages.hsp.score <- as.data.frame(colMeans(BCC.nonresponder.post.averages.hsp, na.rm=TRUE))

## Create dataframe to store all scores

BCC.averages.score <- data.frame()
BCC.averages.score[1:6,1] <- BCC.responder.pre.averages.mhc1.score
BCC.averages.score[1:6,2] <- BCC.responder.pre.averages.mhc2.score
BCC.averages.score[1:6,3] <- BCC.responder.pre.averages.hsp.score
BCC.averages.score[7:12,1] <- BCC.responder.post.averages.mhc1.score
BCC.averages.score[7:12,2] <- BCC.responder.post.averages.mhc2.score
BCC.averages.score[7:12,3] <- BCC.responder.post.averages.hsp.score

BCC.averages.score[13:17,1] <- BCC.nonresponder.pre.averages.mhc1.score
BCC.averages.score[13:17,2] <- BCC.nonresponder.pre.averages.mhc2.score
BCC.averages.score[13:17,3] <- BCC.nonresponder.pre.averages.hsp.score
BCC.averages.score[18:22,1] <- BCC.nonresponder.post.averages.mhc1.score
BCC.averages.score[18:22,2] <- BCC.nonresponder.post.averages.mhc2.score
BCC.averages.score[18:22,3] <- BCC.nonresponder.post.averages.hsp.score

colnames(BCC.averages.score) <- c("MHC1", "MHC2", "HSP")

BCC.averages.score$Response <- c("Responsive.Pre", "Responsive.Pre", "Responsive.Pre", "Responsive.Pre", "Responsive.Pre", "Responsive.Pre", "Responsive.Post", "Responsive.Post", "Responsive.Post", "Responsive.Post", "Responsive.Post", "Responsive.Post",  "Nonresponsive.Pre", "Nonresponsive.Pre", "Nonresponsive.Pre", "Nonresponsive.Pre", "Nonresponsive.Pre", "Nonresponsive.Post", "Nonresponsive.Post", "Nonresponsive.Post", "Nonresponsive.Post", "Nonresponsive.Post")

BCC.averages.score$Patient <- rownames(BCC.averages.score)

BCC.averages.score.melt <- melt(BCC.averages.score, id=c("Response", "Patient"))

BCC.averages.score.melt.MHC1 <- BCC.averages.score.melt[c(1:22),]
BCC.averages.score.melt.MHC2 <- BCC.averages.score.melt[c(23:44),]
BCC.averages.score.melt.HSP <- BCC.averages.score.melt[c(45:66),]

## Plot scores

comparisons <- list(c("Responsive.Pre", "Responsive.Post"), c("Nonresponsive.Pre", "Nonresponsive.Post"), c("Responsive.Pre", "Nonresponsive.Pre"), c("Responsive.Post", "Nonresponsive.Post"))

BCC.averages.score.graph.MHC1 <- ggboxplot(BCC.averages.score.melt.MHC1, x="Response", y="value", color="Response", add = "jitter") + stat_compare_means(comparisons = comparisons)

BCC.averages.score.graph.MHC2 <- ggboxplot(BCC.averages.score.melt.MHC2, x="Response", y="value", color="Response", add = "jitter") + stat_compare_means(comparisons = comparisons)

BCC.averages.score.graph.HSP <- ggboxplot(BCC.averages.score.melt.HSP, x="Response", y="value", color="Response", add = "jitter") + stat_compare_means(comparisons = comparisons)

BCC.averages.score.graph.MHC1 + BCC.averages.score.graph.MHC2 + BCC.averages.score.graph.HSP
  
```



Comparison of BCC Responder vs. Nonresponder, Pretreatment vs. Posttreatment for proliferating T cells

```{r}

## Celltypes that are interesting: CD8_activation, CD8_exhausted, CD8_memory, CD4, Tregs, T_proliferation, Macrophages, Tumor 1, Tumor 2, B cells, NK

CD8activated_graph <- fourway_diffexpression_MHCandHSP("CD8_activation", "Activated CD8+ T cells")
CD8exhausted_graph <- fourway_diffexpression_MHCandHSP("CD8_exhausted", "Exhausted CD8+ T cells")

CD8memory_graph <- fourway_diffexpression_MHCandHSP("CD8_memory", "Memory CD8+ T cells")
CD4_graph <- fourway_diffexpression_MHCandHSP("CD4", "CD4+ T cells")
Tregs_graph <- fourway_diffexpression_MHCandHSP("Tregs", "Regulatory T cells")
Tproliferation_graph <- fourway_diffexpression_MHCandHSP("T_proliferation", "Proliferating T cells")

Macrophage_graph <- fourway_diffexpression_MHCandHSP("Macrophages", "Macrophages")
Malignant_graph <- fourway_diffexpression_MHCandHSP(c("Tumor 1", "Tumor 2"), "Malignant cells")
Bcell_graph <- fourway_diffexpression_MHCandHSP("B cells", "B cells")
NK_graph <- fourway_diffexpression_MHCandHSP("NK", "NK cells")

```