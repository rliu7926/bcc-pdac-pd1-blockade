---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. `

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

```{r}
## Load packages
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
```


Read data from GSE123813 (pape: clonal replacement of tumor-specific T cells following PD-1 blockade)
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE123813

```{r}
## Read data
BCCIO.read <- read.table("C:\\Users\\Ryan\\Downloads\\GSE 123813\\bcc_scRNA_counts.txt", row.names = 1, sep="\t", as.is=T)

## Read metadata
BCCIO.meta.data.readall <- read.table("C:\\Users\\Ryan\\Downloads\\GSE 123813\\bcc_all_metadata.txt", row.names = 1, sep="\t", as.is=T)

## Format metadata
BCCIO.meta.data.read_colnamesall <- BCCIO.meta.data.readall[1,] # Store column names 

BCCIO.meta.data <- BCCIO.meta.data.readall[2:nrow(BCCIO.meta.data.readall),] # Get rid of column names (first row)

names(BCCIO.meta.data) <- BCCIO.meta.data.read_colnamesall # Change the column names
```


Create Seurat object

```{r}
memory.limit(size = 16000000) #Increase memory limit for vector sizes 
BCCIO <- CreateSeuratObject(counts = BCCIO.read, project = "BCCIO", min.cells = 3, min.features = 200, meta.data = BCCIO.meta.data)
```


Pre-processing workflow

```{r}

BCCIO <- NormalizeData(BCCIO, normalization.method= "LogNormalize", scale.factor = 10000) # Normalize feature expression 

BCCIO <- FindVariableFeatures(BCCIO, selection.method = "vst", nfeatures = 2000) # Feature selection (highly variable features)

all.genes <- rownames(BCCIO)
BCCIO <- ScaleData(BCCIO, features = all.genes) # Scale data in preparation for PCA 
BCCIO <- RunPCA(BCCIO, features = VariableFeatures(object = BCCIO)) # Perform PCA
```


Checkpoint (Save Work Here)

```{r}

save(BCCIO, file="C:\\Users\\Ryan\\Downloads\\GSE 123813\\BCCIO")
save(BCCIO.meta.data,BCCIO.read, file = "C:\\Users\\Ryan\\Downloads\\GSE 123813\\BCCIOrawdata")

## To load data use load(filelocation) function
load("C:\\Users\\Ryan\\Downloads\\GSE 123813\\BCCIO")
```


Elbow Plot (Determine # of PCs to consider)

```{r}

ElbowPlot(BCCIO, ndims=50)
DimHeatmap(BCCIO, dims = 1:24, cells = 500, balanced = TRUE)

```


Test out Clustering (Varying Resolution Levels)
Higher resolution = greater clustering

```{r}

BCCIO <- FindNeighbors(BCCIO, dims = 1:15)

## Start with r = 0.3 (overclustered)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.2 (overclustered)

BCCIO <- FindClusters(BCCIO, resolution = 0.2, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.1 (overclustered)

BCCIO <- FindClusters(BCCIO, resolution = 0.1, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.05 (looks okay)

BCCIO <- FindClusters(BCCIO, resolution = 0.05, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)


## Try r = 0.03 (around the same as 0.05)

BCCIO <- FindClusters(BCCIO, resolution = 0.04, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.3, bimod test (identical to wilcox)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'bimod', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.3, roc test (error)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'roc', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.3, t test (identical to wilcox)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 't', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Try r = 0.3, LR test (identical to wilcox)

BCCIO <- FindClusters(BCCIO, resolution = 0.3, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'LR', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

## Start with r = 0.4

BCCIO <- FindClusters(BCCIO, resolution = 0.4, algorithm = 3)
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = 500)
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3)

```

Full DE Testing (UMAP) for r=0.4, test=wilcox

```{r}

BCCIO <- FindNeighbors(BCCIO, dims = 1:50)
BCCIO <- FindClusters(BCCIO, resolution = 0.4, algorithm = 3) ## Set r = 0.3
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.25, max.cells.per.ident = 500) ## Run through all cells
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3) ## Heatmap with all cells

top25 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=25, wt=avg_logFC)
BCCIO.top25genes <- top25[c(6,7)]

BCCIO.top2genes <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=2, wt=avg_logFC)
BCCIO.geneslist <- unique(unlist(top2[7]))

labels <- c("CD56+ NK 1", "CD4+ T 1", "CD19+ B 1", "CD56+ NK 2", "CD4+ T 2", "CD33+ Myeloid", "BDCA4+ Dendritic 1", "??1", "CD4+ T 3", "721 B Lymphoblasts", "BDCA4+ Dendritic 2", "??2", "??3", "??4", "??5", "??6", "??7", "??8", "CD34+", "CD19+ B 2")

names(labels) <- levels(BCCIO)
BCCIO <- RenameIdents(BCCIO, labels)

new_idents <- rep(c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"), times=c("CD56+ NK 1", "CD4+ T 1", "CD19+ B 1", "CD56+ NK 2", "CD4+ T 2", "CD33+ Myeloid", "BDCA4+ Dendritic 1", "??1", "CD4+ T 3", "721 B Lymphoblasts", "BDCA4+ Dendritic 2", "??2", "??3", "??4", "??5", "??6", "??7", "??8", "CD34+", "CD19+ B 2"))


BCCIO <- RunUMAP(BCCIO, dims = 1:50)
DimPlot(BCCIO, reduction="umap", label=TRUE, pt.size = 0.1) + NoLegend() ## Create labeled UMAP

```

Clustering Comparison Heatmap 

```{r}

BCCIO.meta.data1 <- BCCIO.meta.data[order(BCCIO.meta.data[, "sort"], -xtfrm(BCCIO.meta.data[, "treatment"])),]
BCCIO.meta.data2 <- BCCIO@meta.data[order(BCCIO@meta.data[, "sort"]),]

BCCIO.meta.data1["rownames"] <- rownames(BCCIO.meta.data1)
BCCIO.meta.data2["rownames"] <- rownames(BCCIO.meta.data2)

BCCIO.meta.data.merge <- merge(BCCIO.meta.data1, BCCIO.meta.data2, by.x=c("rownames"), by.y=c("rownames"))
BCCIO.clustering.comparison <- BCCIO.meta.data.merge[c("cluster", "seurat_clusters")]

uniqueclusters1 <- as.matrix(unique(BCCIO.clustering.comparison[,1]))
uniqueclusters2 <- as.matrix(unique(BCCIO.clustering.comparison[,2]))

BCCIO.distribution.table <- data.frame(matrix(0, nrow=nrow(uniqueclusters1), ncol=nrow(uniqueclusters2)))
for (cluster1 in 1:nrow(uniqueclusters1)) {
  for (cluster2 in 1:nrow(uniqueclusters2)) {
    for (row in 1:53029) {
      if ((BCCIO.clustering.comparison[row,1] == uniqueclusters1[cluster1,]) & (BCCIO.clustering.comparison[row,2] == uniqueclusters2[cluster2,])) {
        BCCIO.distribution.table[cluster1, cluster2] <- BCCIO.distribution.table[cluster1, cluster2] + 1
      }
    }
  }
}

BCCIO.distribution.table <- as.data.frame(BCCIO.distribution.table)
BCCIO.distribution.table <- as.matrix(BCCIO.distribution.table)


rownames(BCCIO.distribution.table) <- uniqueclusters1
colnames(BCCIO.distribution.table) <- uniqueclusters2

BCCIO.distribution.table <- mapply(BCCIO.distribution.table, FUN=as.numeric)

colnames(BCCIO.distribution.table) <- c("CD56+ NK1", "CD4+ T1", "CD4+ T2", "721 B Lymphoblasts", "CD34+", "CD4+ T3", "CD56+ NK2", "CD19+ B1", "CD33+ Myeloid", "BDCA4+ Dendritic2", "BDCA4+ Dendritic1", "??5", "CD19+ B2", "CAFs", "Endothelial", "Myofibroblasts", "??8", "Tumor1", "Tumor2", "Melanocytes")

BCCIO.proportions.table <- prop.table(BCCIO.distribution.table,1)
BCCIO.proportions.table <- unlist(BCCIO.proportions.table)
BCCIO.proportions.table <- as.data.frame(BCCIO.proportions.table)

BCCIO.clustering.heatmap <- ggplot(BCCIO.proportions.table, aes(uniqueclusters2, uniqueclusters1, fill=Proportion)) + geom_tile() + scale_fill_distiller(palette = "Spectral") + theme(axis.text.x = element_text(angle=45, hjust=1)) + labs(x="My Clustering", y="Metadata Clustering")
BCCIO.clustering.heatmap

x <- uniqueclusters1
y <- uniqueclusters2
data <- expand.grid(X=x, Y=y)
data$Z <- BCCIO.proportions.table
BCCIO.clustering.heatmap <- ggplot(data, aes(X, Y, fill=Z)) + geom_tile() + scale_fill_distiller(palette="Spectral") + theme(axis.text.x = element_text(angle=45, hjust=1)) + labs(x="My Clustering", y="Metadata Clustering")
BCCIO.clustering.heatmap

```





Comparison of Pre- and Post-Treatment

```{r}

DimPlot(BCCIO, reduction="umap", split.by="treatment")

DotPlot(BCCIO, features=rev(BCCIO.geneslist), cols=c("blue", "red"), dot.scale=8, split.by="treatment") + RotatedAxis()

DimPlot(BCCIO, reduction="umap", split.by="patient")



```






















UMAP Clustering (Following Paper) (not used anymore)

```{r}

BCCIO <- FindNeighbors(BCCIO, compute.SNN = TRUE, k.param = 30)

BCCIO <- FindClusters(BCCIO, resolution = 0.4, algorithm = 3) 
BCCIO.markers <- FindAllMarkers(BCCIO, test.use = 'wilcox', min.pct = 0.25, logfc.threshold = 0.50, max.cells.per.ident = Inf) 
top5 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=5, wt=avg_logFC)
DoHeatmap(BCCIO,features = top5$gene, size = 3) ## Heatmap with all cells

BCCIO <- RunUMAP(BCCIO, dims = 1:10)
DimPlot(BCCIO, reduction="umap")

top25 <- BCCIO.markers %>% group_by(cluster) %>% top_n(n=25, wt=avg_logFC) ## top 25 markers per cluster for UMAP labeling

labels <- c("CD4+ T Cells", "CD19+ B Cells", "Smooth Muscle 1", "Small Intestine", "Bronchial Epithelial Cells", "Smooth Muscle 2", "721 B Lymphocytes", "Tongue", "Cardiac Myocytes") ## Lables found using Human Gene Atlas on Enrichr

names(labels) <- levels(BCCIO)
BCCIO <- RenameIdents(BCCIO, labels)

BCCIO <- RunUMAP(BCCIO, dims = 1:10)
DimPlot(BCCIO, reduction="umap", label=TRUE) ## Create labeled UMAP

```
