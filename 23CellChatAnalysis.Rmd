---
title: "CellChat Analysis"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

Load Packages and Data
** R STUDIO 3.6.2 USED HERE (V 4 ELSEWHERE)

```{r}
## Load packages
library(dplyr)
library(Seurat)
library(patchwork)
library(ggplot2)
library(cowplot)
library(pracma)
library(RColorBrewer)
library(EnhancedVolcano)
library(gridExtra)
library(reshape2)
library(CellChat)
library(NMF)

memory.limit(size = 16000000)

## BCC Cellchat Object
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.cellchat")

## PDAC Integrated Cellchat Object
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\PDAC.cellchat")

## BCC Responders Object 
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.responders.cellchat")

## BCC Nonresponders Object
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.nonresponders.cellchat")

## CellChat Object: BCC Pre-treatment + Post-treatment Responders + Nonresponders
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.pre.responders.cellchat")
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.pre.nonresponders.cellchat")
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.post.responders.cellchat")
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.post.nonresponders.cellchat")

## Load functions
source("ClusteringAnalysisFunctions.R", echo=FALSE)
source("SeuratClusteringFunctions.R", echo=FALSE)
source("DifferentialExpressionFunctions.R", echo=FALSE)
source("CellChatFunctions.R", echo=FALSE)
```



Explore CellChat

```{r}

## Create cellchat objects for BCC and PDAC

BCC.cellchat <- createCellChat(object = BCCIO, meta = BCCIO@meta.data, group.by = "seurat_clusters")

PDAC.cellchat <- createCellChat(object = PDAC155698.integrated, meta= PDAC155698.integrated@meta.data, group.by="sub_cluster")

## Select MHC interactions

CellChatDB <- CellChatDB.human
CellChatDB.use <- subsetDB(CellChatDB, search = "Cell-Cell Adhesion")
CellChatDB.use <- CellChatDB

BCC.cellchat@DB <- CellChatDB.use
PDAC.cellchat@DB <- CellChatDB.use

## Preprocessing 

BCC.cellchat <- subsetData(BCC.cellchat)
PDAC.cellchat <- subsetData(PDAC.cellchat)

BCC.cellchat <- identifyOverExpressedGenes(BCC.cellchat)
BCC.cellchat <- identifyOverExpressedInteractions(BCC.cellchat)
BCC.cellchat <- projectData(BCC.cellchat, PPI.human)

save(BCC.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.cellchat")


PDAC.cellchat <- identifyOverExpressedGenes(PDAC.cellchat)
PDAC.cellchat <- identifyOverExpressedInteractions(PDAC.cellchat)
PDAC.cellchat <- projectData(PDAC.cellchat, PPI.human)

save(PDAC.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\PDAC.cellchat")

```



Explore cell-cell communication networks for BCC and PDAC: Communication probabilities between clusters (cell-cell adhesion)

```{r}

## Compute communication probability

BCC.cellchat <- computeCommunProb(BCC.cellchat, raw.use = TRUE)
BCC.cellchat <- filterCommunication(BCC.cellchat, min.cells = 10)

PDAC.cellchat <- computeCommunProb(PDAC.cellchat, raw.use = TRUE)
PDAC.cellchat <- filterCommunication(PDAC.cellchat, min.cells = 10)

## Infer cell-cell communication at signaling pathway level

BCC.cellchat <- computeCommunProbPathway(BCC.cellchat)
PDAC.cellchat <- computeCommunProbPathway(PDAC.cellchat)

## Calculate and visualize aggregated cell-cell communication network

BCC.cellchat <- aggregateNet(BCC.cellchat)
groupSize <- as.numeric(table(BCC.cellchat@idents))
netVisual_circle(BCC.cellchat@net$count, vertex.weight = groupSize, weight.scale = T, label.edge = F, title.name = "Number of Interactions")
netVisual_circle(BCC.cellchat@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge = F, title.name = "Interaction weights/strength")

PDAC.cellchat <- aggregateNet(PDAC.cellchat)
groupSize <- as.numeric(table(PDAC.cellchat@idents))
netVisual_circle(PDAC.cellchat@net$count, vertex.weight = groupSize, weight.scale = T, label.edge = F, title.name = "Number of Interactions")
netVisual_circle(PDAC.cellchat@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge = F, title.name = "Interaction weights/strength")

## Visualize each cluster separately

BCC.weights <- BCC.cellchat@net$weight
par(mfrow = c(4,5), mar= c(1, 1, 1, 1))
plots <- vector(mode = "list", length = 20)
matrix <- matrix(0, nrow = nrow(BCC.weights), ncol=ncol(BCC.weights), dimnames = dimnames(BCC.weights))
for (i in 1:nrow(BCC.weights)) {
  matrix <- matrix(0, nrow = nrow(BCC.weights), ncol=ncol(BCC.weights), dimnames = dimnames(BCC.weights))
  matrix[i, ] <- BCC.weights[i, ]
  netVisual_circle(matrix, vertex.weight = groupSize, weight.scale = T, edge.weight.max = max(BCC.weights), title.name = rownames(BCC.weights)[i])
}

PDAC.weights <- PDAC.cellchat@net$weight
par(mfrow = c(4,4), mar= c(1, 1, 1, 1))
plots <- vector(mode = "list", length = 20)
matrix <- matrix(0, nrow = nrow(PDAC.weights), ncol=ncol(PDAC.weights), dimnames = dimnames(PDAC.weights))
for (i in 1:nrow(PDAC.weights)) {
  matrix <- matrix(0, nrow = nrow(PDAC.weights), ncol=ncol(PDAC.weights), dimnames = dimnames(PDAC.weights))
  matrix[i, ] <- PDAC.weights[i, ]
  netVisual_circle(matrix, vertex.weight = groupSize, weight.scale = T, edge.weight.max = max(PDAC.weights), title.name = rownames(PDAC.weights)[i])
}

```



Visualization of cell-cell communication network, looking specifically at MHC-I, MHC-II, PD-L1, PDL2

```{R}

pathways <- c("MHC-I", "MHC-II", "PD-L1", "PDL2")

## Circle plots

par(mfrow = c(1,4), mar = c(1,1,1,1))
for (i in 1:length(pathways)) {
  netVisual_aggregate(BCC.cellchat, signaling = pathways[i], layout = "circle")
}

par(mfrow = c(1,4), mar = c(1,1,1,1))
for (i in 1:length(pathways)) {
  netVisual_aggregate(PDAC.cellchat, signaling = pathways[i], layout = "circle")
}

## Compare contribution of ligand-receptor pair to overall signaling pathway in MHC

par(mfrow = c(2,4), mar = c(1,1,1,1))

# For loop did not work
netAnalysis_contribution(BCC.cellchat, signaling = pathways[1], title = paste0("Contribution of L-R Pairs: ", pathways[1], " (BCC)"))
netAnalysis_contribution(BCC.cellchat, signaling = pathways[2], title = paste0("Contribution of L-R Pairs: ", pathways[2], " (BCC)"))
netAnalysis_contribution(BCC.cellchat, signaling = pathways[3], title = paste0("Contribution of L-R Pairs: ", pathways[3], " (BCC)"))
netAnalysis_contribution(BCC.cellchat, signaling = pathways[4], title = paste0("Contribution of L-R Pairs: ", pathways[4], " (BCC)"))

netAnalysis_contribution(PDAC.cellchat, signaling = pathways[1], title = paste0("Contribution of L-R Pairs: ", pathways[1], " (PDAC)"))
netAnalysis_contribution(PDAC.cellchat, signaling = pathways[2], title = paste0("Contribution of L-R Pairs: ", pathways[2], " (PDAC)"))
netAnalysis_contribution(PDAC.cellchat, signaling = pathways[3], title = paste0("Contribution of L-R Pairs: ", pathways[3], " (PDAC)"))
netAnalysis_contribution(PDAC.cellchat, signaling = pathways[4], title = paste0("Contribution of L-R Pairs: ", pathways[4], " (PDAC)"))

## Plot signaling gene expression distribution 

plotGeneExpression(BCC.cellchat, signaling = "MHC-I")
plotGeneExpression(PDAC.cellchat, signaling = "MHC-I")

plotGeneExpression(BCC.cellchat, signaling = "MHC-II")
plotGeneExpression(PDAC.cellchat, signaling = "MHC-II")

## Bubble plot of all significant interactions

# Macrophages
netVisual_bubble(BCC.cellchat, sources.use = 7, targets.use = c(1, 2, 4, 5, 6, 11, 9, 15), signaling = pathways, remove.isolate = FALSE)
netVisual_bubble(PDAC.cellchat, sources.use = 10, targets.use = c(1, 3, 4), signaling = pathways, remove.isolate = FALSE)


```



###############################    Compare BCC responders vs. nonresponders   ###################################


Create CellChat objects for responders and nonresponders

```{r}

Idents(BCCIO) <- BCCIO$response
BCC.responders <- subset(BCCIO, idents = "Responsive")
BCC.nonresponders <- subset(BCCIO, idents = "Nonresponsive")
remove(BCCIO)

BCC.responders.cellchat <- createCellChat(object = BCC.responders, meta = BCC.responders@meta.data, group.by = "seurat_clusters")
BCC.nonresponders.cellchat <- createCellChat(object = BCC.nonresponders, meta = BCC.nonresponders@meta.data, group.by = "seurat_clusters")
remove(BCC.responders)
remove(BCC.nonresponders)

CellChatDB <- CellChatDB.human
CellChatDB.use <- subsetDB(CellChatDB, search = "Cell-Cell Adhesion")
CellChatDB.use <- CellChatDB

BCC.responders.cellchat@DB <- CellChatDB.use
BCC.nonresponders.cellchat@DB <- CellChatDB.use

BCC.responders.cellchat <- subsetData(BCC.responders.cellchat)
BCC.nonresponders.cellchat <- subsetData(BCC.nonresponders.cellchat)

BCC.responders.cellchat <- identifyOverExpressedGenes(BCC.responders.cellchat)
BCC.responders.cellchat <- identifyOverExpressedInteractions(BCC.responders.cellchat)
BCC.responders.cellchat <- projectData(BCC.responders.cellchat, PPI.human)

BCC.nonresponders.cellchat <- identifyOverExpressedGenes(BCC.nonresponders.cellchat)
BCC.nonresponders.cellchat <- identifyOverExpressedInteractions(BCC.nonresponders.cellchat)
BCC.nonresponders.cellchat <- projectData(BCC.nonresponders.cellchat, PPI.human)

BCC.responders.cellchat <- computeCommunProb(BCC.responders.cellchat, raw.use = TRUE)
BCC.responders.cellchat <- filterCommunication(BCC.responders.cellchat, min.cells = 10)

BCC.nonresponders.cellchat <- computeCommunProb(BCC.nonresponders.cellchat, raw.use = TRUE)
BCC.nonresponders.cellchat <- filterCommunication(BCC.nonresponders.cellchat, min.cells = 10)

BCC.responders.cellchat <- computeCommunProbPathway(BCC.responders.cellchat)
BCC.nonresponders.cellchat <- computeCommunProbPathway(BCC.nonresponders.cellchat)

BCC.responders.cellchat <- aggregateNet(BCC.responders.cellchat)
BCC.nonresponders.cellchat <- aggregateNet(BCC.nonresponders.cellchat)

object.list <- list(responder = BCC.responders.cellchat, nonresponder = BCC.nonresponders.cellchat)
response.cellchat <- mergeCellChat(object.list, add.names = names(object.list))

save(BCC.responders.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.responders.cellchat")
save(BCC.nonresponders.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.nonresponders.cellchat")

```



Comparison Analysis for BCC Responders vs. Nonresponders (All)

```{r}

## Compare total number of interactions and interaction strength

interaction1 <- compareInteractions(response.cellchat, show.legend = F, group = c(1,2))
interaction2 <- compareInteractions(response.cellchat, show.legend = F, group = c(1,2), measure = "weight")
interaction1 + interaction2

## Differential interaction strength among different cell populations

netVisual_diffInteraction(response.cellchat, weight.scale = T)
netVisual_diffInteraction(response.cellchat, weight.scale = T, measure= "weight")

netVisual_diffInteraction(response.cellchat, sources.use = celltypes, targets.use = celltypes, weight.scale = T, measure = "weight", remove.isolate = T)

par(mfrow = c(2,2))
netVisual_heatmap(response.cellchat, measure = "weight", signaling = "MHC-I", slot.name = "netP", title.name = "Differential interaction strength: MHC Class I")
netVisual_heatmap(response.cellchat, measure = "weight", signaling = "MHC-II", title.name = "Differential interaction strength: MHC Class II")
netVisual_heatmap(response.cellchat, measure = "weight", signaling = "PD-L1", title.name = "Differential interaction strength: PD-L1")
netVisual_heatmap(response.cellchat, measure = "weight", signaling = "PDL2", title.name = "Differential interaction strength: PD-L2")

## Compare outgoing and incoming interaction strengths

weight.max <- list()
weight.max <- getMaxWeight(object.list, attribute = c("idents", "count"))
for (i in 1:length(object.list)) {
  netVisual_circle(object.list[[i]]@net$count, weight.scale = T, label.edge = F, edge.weight.max = weight.max[2], edge.width.max = 12, title.name = paste0("Number of interactions: ", names(object.list)[i]))
}

num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count) - diag(x@net$count)})
weight.minmax <- c(min(num.link), max(num.link))


for (i in 1:length(object.list)) {
  object.list[[i]] <- netAnalysis_computeCentrality(object = object.list[[i]])
}

gg <- list()
for (i in 1:length(object.list)) {
    gg[[i]] <- netAnalysis_signalingRole_scatter(object.list[[i]], title= names(object.list)[i], weight.MinMax = weight.minmax)
}
patchwork::wrap_plots(plots = gg)

## Identify signaling networks/groups with larger or less difference based on their functional and structural similarity

response.cellchat <- computeNetSimilarityPairwise(response.cellchat, type = "functional")
response.cellchat <- netEmbedding(response.cellchat, type = "functional")
response.cellchat <- netClustering(response.cellchat, type = "functional")
netVisual_embeddingPairwise(response.cellchat, type = "functional")

response.cellchat <- computeNetSimilarityPairwise(response.cellchat, type = "structural")
response.cellchat <- netEmbedding(response.cellchat, type = "structural")
response.cellchat <- netClustering(response.cellchat, type = "structural")
netVisual_embeddingPairwise(response.cellchat, type = "structural")

```



Identify upregulated and downregulated signaling LR pairs

```{r}

celltypes <- c("CD8_activation", "CD8_exhausted", "CD8_memory", "CD4", "Tregs", "T_proliferation", "Macrophages", "Tumor 1", "Tumor 2", "B cells")

## Compare communication probabilities for macrophages
netVisual_bubble(response.cellchat, sources.use = "Macrophages", targets.use = celltypes, comparison = c(1,2), angle.x = 45)

gg1 <- netVisual_bubble(response.cellchat, sources.use = "Macrophages", targets.use = celltypes, comparison = c(1,2), max.dataset = 2, title.name = "Increased Signaling in Nonresponders")
gg2 <- netVisual_bubble(response.cellchat, sources.use = "Macrophages", targets.use = celltypes, comparison = c(1,2), max.dataset = 1, title.name = "Increased Signaling in Responders")
gg1 + gg2

## Plot signaling gene expression distribution 
response.cellchat@meta$datasets = factor(response.cellchat@meta$datasets, levels = c("Responsive", "Nonresponsive"))
plotGeneExpression(response.cellchat, idents = celltypes, signaling = pathways, type = "violin", split.by = "response")


```



############  Compare BCC Responders vs. Nonresponders Pre-treatment and Post-treatment  ############

Create CellChat objects 

```{r}

## Load BCC Seurat object
load("C:\\Users\\Ryan\\Documents\\Nie Research Project\\GSE 123813\\BCCIOwithUMAP")

## Subset Seurat objects 
Idents(BCCIO) <- BCCIO$treatment
BCC.pre <- subset(BCCIO, idents="pre")
BCC.post <- subset(BCCIO, idents="post")
remove(BCCIO)

Idents(BCC.pre) <- BCC.pre$response
Idents(BCC.post) <- BCC.post$response

BCC.pre.responders <- subset(BCC.pre, idents="Responsive")
BCC.pre.nonresponders <- subset(BCC.pre, idents="Nonresponsive")
remove(BCC.pre)

BCC.post.responders <- subset(BCC.post, idents="Responsive")
BCC.post.nonresponders <- subset(BCC.post, idents="Nonresponsive")
remove(BCC.post)

## Create CellChat objects 
BCC.pre.responders.cellchat <- createCellChat(object = BCC.pre.responders, meta = BCC.pre.responders@meta.data, group.by = "seurat_clusters")
BCC.pre.nonresponders.cellchat <- createCellChat(object = BCC.pre.nonresponders, meta = BCC.pre.nonresponders@meta.data, group.by = "seurat_clusters")
BCC.post.responders.cellchat <- createCellChat(object = BCC.post.responders, meta = BCC.post.responders@meta.data, group.by = "seurat_clusters")
BCC.post.nonresponders.cellchat <- createCellChat(object = BCC.post.nonresponders, meta = BCC.post.nonresponders@meta.data, group.by = "seurat_clusters")

remove(BCC.pre.responders)
remove(BCC.pre.nonresponders)
remove(BCC.post.responders)
remove(BCC.post.nonresponders)

## Preprocessing steps
CellChatDB <- CellChatDB.human
CellChatDB.use <- subsetDB(CellChatDB, search = "Cell-Cell Adhesion")
CellChatDB.use <- CellChatDB

BCC.pre.responders.cellchat <- preprocessingCellChat(BCC.pre.responders.cellchat)
BCC.pre.nonresponders.cellchat <- preprocessingCellChat(BCC.pre.nonresponders.cellchat)
BCC.post.responders.cellchat <- preprocessingCellChat(BCC.post.responders.cellchat)
BCC.post.nonresponders.cellchat <- preprocessingCellChat(BCC.post.nonresponders.cellchat)

## Save CellChat objects
save(BCC.pre.responders.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.pre.responders.cellchat")
save(BCC.pre.nonresponders.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.pre.nonresponders.cellchat")
save(BCC.post.responders.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.post.responders.cellchat")
save(BCC.post.nonresponders.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\BCC.post.nonresponders.cellchat")

```



Comparison of pretreatment responders vs. nonresponders

```{r}

## Define clusters and pathways of interest

celltypes <- c("CD8_activation", "CD8_exhausted", "CD8_memory", "CD4", "Tregs", "T_proliferation", "Tumor 1", "Tumor 2")
pathways <- c("MHC-I", "MHC-II", "PD-L1", "PDL2")

pre.object.list <- list(Responsive = BCC.pre.responders.cellchat, Nonresponsive = BCC.pre.nonresponders.cellchat)
pre.response.cellchat <- mergeCellChat(pre.object.list, add.names = names(pre.object.list))


## Compare total number of interactions and interaction strength

interaction1 <- compareInteractions(pre.response.cellchat, show.legend = F, group = c(1,2))
interaction2 <- compareInteractions(pre.response.cellchat, show.legend = F, group = c(1,2), measure = "weight")
interaction1 + interaction2

## Differential interaction strength among different cell populations (not working still)

netVisual_diffInteraction(pre.response.cellchat, sources.use = celltypes, targets.use = celltypes, weight.scale = T, measure = "weight", remove.isolate = T, title="Differential Interaction Strength")

## Heatmaps of pathway communication probabilities 

netVisual_heatmap(BCC.pre.responders.cellchat, signaling = "MHC-I", title.name = "MHC-I Signaling Network: BCC Pretreatment Responders")
netVisual_heatmap(BCC.pre.nonresponders.cellchat, signaling = "MHC-I", title.name = "MHC-I Signaling Network: BCC Pretreatment Nonresponders")

netVisual_heatmap(BCC.pre.responders.cellchat, signaling = "MHC-II", title.name = "MHC-II Signaling Network: BCC Pretreatment Responders")
netVisual_heatmap(BCC.pre.nonresponders.cellchat, signaling = "MHC-II", title.name = "MHC-I Signaling Network: BCC Pretreatment Nonresponders")

netVisual_heatmap(BCC.pre.responders.cellchat, signaling = "PD-L1", title.name = "PD-L1 Signaling Network: BCC Pretreatment Responders")
netVisual_heatmap(BCC.pre.nonresponders.cellchat, signaling = "PD-L1", title.name = "PD-L1 Signaling Network: BCC Pretreatment Nonresponders")

netVisual_heatmap(BCC.pre.responders.cellchat, signaling = "PDL2", title.name = "PD-L2 Signaling Network: BCC Pretreatment Responders")
netVisual_heatmap(BCC.pre.nonresponders.cellchat, signaling = "PDL2", title.name = "PD-L2 Signaling Network: BCC Pretreatment Nonresponders")


## Compare outgoing and incoming interaction strengths

weight.max <- list()
weight.max <- getMaxWeight(pre.object.list, attribute = c("idents", "count"))
for (i in 1:length(pre.object.list)) {
  netVisual_circle(pre.object.list[[i]]@net$count, weight.scale = T, label.edge = F, edge.weight.max = weight.max[2], edge.width.max = 12, title.name = paste0("Number of interactions: ", names(pre.object.list)[i]))
}

num.link <- sapply(pre.object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count) - diag(x@net$count)})
weight.minmax <- c(min(num.link), max(num.link))

for (i in 1:length(pre.object.list)) {
  pre.object.list[[i]] <- netAnalysis_computeCentrality(object = pre.object.list[[i]])
}

names <- c("Responders", "Nonresponders")

for (i in 1:length(pre.object.list)) {
    netAnalysis_signalingRole_scatter(pre.object.list[[i]], title= names[i], weight.MinMax = weight.minmax)
}

## Compare signaling pathways of MHC and PD-1 pathways

genes <- c('MHC-I', 'MHC-I1', 'MHC-II', 'MHC-II1', 'PD-L1', 'PD-L11', 'PDL2', 'PDL21')

gg1 <- rankNet(pre.response.cellchat, mode="comparison", stacked=T, do.stat=TRUE)
gg1.data.filter <- gg1$data[genes, ]

for (i in 1:nrow(gg1.data.filter)) {
  gg1.data.filter$relative[i] <- gg1.data.filter$contribution[i] / (gg1.data.filter$contribution[ceil(i/2)*2-1] + gg1.data.filter$contribution[ceil(i/2)*2])
}

pre.signaling.ranknet <- ggplot(gg1.data.filter, aes(x=relative, y=name, fill=group)) + geom_bar(stat="identity") +
  geom_vline(xintercept=0.50, linetype="solid", color="black", size=1) + theme_bw() +
  labs(x="Relative Information Flow", y="Signaling Pathway", fill="Response", title="Pre-Treatment") +
  theme(legend.position="bottom", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5))

## Simplified comparison of outgoing and incoming interaction strengths

group.cellType <- c("T cells", "T cells", "Other", "T cells", "T cells", "T cells", "Other", "Malignant", "T cells", "T cells", "Other", "Other", "Other", "Malignant", "Other", "Other", "Other", "Other")
group.cellType <- factor(group.cellType)
pre.object.list <- lapply(pre.object.list, function(x) {mergeInteractions(x, group.cellType)})
pre.response.cellchat <- mergeCellChat(pre.object.list, add.names = names(pre.object.list))

names <- c("Responders", "Nonresponders")
weight.max <- getMaxWeight(pre.object.list, slot.name=c("idents", "net", "net"), attribute=c("idents", "count", "count.merged"))
for (i in 1:length(pre.object.list)) {
  netVisual_circle(pre.object.list[[i]]@net$count.merged, weight.scale = T, label.edge = T, edge.weight.max = weight.max[3], edge.width.max = 12, title.name = paste0("Number of Interactions - ", names[i]))
}

gg1 <- netVisual_diffInteraction(pre.response.cellchat, weight.scale = T, measure = "count.merged", label.edge = T)
gg2 <- netVisual_diffInteraction(pre.response.cellchat, weight.scale = T, measure = "weight.merged", label.edge = T)

## Identify signaling networks/groups with larger or less difference based on their functional and structural similarity

pre.response.cellchat <- computeNetSimilarityPairwise(pre.response.cellchat, type = "functional")
pre.response.cellchat <- netEmbedding(pre.response.cellchat, type = "functional")
pre.response.cellchat <- netClustering(pre.response.cellchat, type = "functional")
netVisual_embeddingPairwise(pre.response.cellchat, type = "functional")

pre.response.cellchat <- computeNetSimilarityPairwise(pre.response.cellchat, type = "structural")
pre.response.cellchat <- netEmbedding(pre.response.cellchat, type = "structural")
pre.response.cellchat <- netClustering(pre.response.cellchat, type = "structural")
netVisual_embeddingPairwise(pre.response.cellchat, type = "structural")


```



Comparison of posttreatment responders vs. nonresponders 

```{r}

## Define clusters and pathways of interest

celltypes <- c("CD8_activation", "CD8_exhausted", "CD8_memory", "CD4", "Tregs", "T_proliferation", "Macrophages", "Tumor 1", "Tumor 2", "B cells")
pathways <- c("MHC-I", "MHC-II", "PD-L1", "PDL2")

post.object.list <- list(Responsive = BCC.post.responders.cellchat, Nonresponsive = BCC.post.nonresponders.cellchat)
post.response.cellchat <- mergeCellChat(post.object.list, add.names = names(post.object.list))


## Compare total number of interactions and interaction strength

interaction1 <- compareInteractions(post.response.cellchat, show.legend = F, group = c(1,2))
interaction2 <- compareInteractions(post.response.cellchat, show.legend = F, group = c(1,2), measure = "weight")
interaction1 + interaction2

## Differential interaction strength among different cell populations (not working still)

netVisual_diffInteraction(post.response.cellchat, sources.use = celltypes, targets.use = celltypes, weight.scale = T, measure = "weight", remove.isolate = T, title="Differential Interaction Strength: \nBCC Posttreatment Responders vs. Nonresponders")

## Heatmaps of pathway communication probabilities 

netVisual_heatmap(BCC.post.responders.cellchat, signaling = "MHC-I", title.name = "MHC-I Signaling Network: BCC Posttreatment Responders")
netVisual_heatmap(BCC.post.nonresponders.cellchat, signaling = "MHC-I", title.name = "MHC-I Signaling Network: BCC Posttreatment Nonresponders")

netVisual_heatmap(BCC.post.responders.cellchat, signaling = "MHC-II", title = "MHC-II Signaling Network: BCC Posttreatment Responders")
netVisual_heatmap(BCC.post.nonresponders.cellchat, signaling = "MHC-II", title = "MHC-II Signaling Network: BCC Posttreatment Nonresponders")

netVisual_heatmap(BCC.post.responders.cellchat, signaling = "PD-L1", title = "PD-L1 Signaling Network: BCC Posttreatment Responders")
netVisual_heatmap(BCC.post.nonresponders.cellchat, signaling = "PD-L1", title = "PD-L1 Signaling Network: BCC Posttreatment Nonresponders")

netVisual_heatmap(BCC.post.responders.cellchat, signaling = "PDL2", title = "PD-L2 Signaling Network: BCC Posttreatment Responders")
netVisual_heatmap(BCC.post.nonresponders.cellchat, signaling = "PDL2", title = "PD-L2 Signaling Network: BCC Posttreatment Nonresponders")


## Compare outgoing and incoming interaction strengths

weight.max <- list()
weight.max <- getMaxWeight(post.object.list, attribute = c("idents", "count"))
for (i in 1:length(post.object.list)) {
  netVisual_circle(post.object.list[[i]]@net$count, weight.scale = T, label.edge = F, edge.weight.max = weight.max[2], edge.width.max = 12, title.name = paste0("Number of interactions: ", names(post.object.list)[i]))
}

num.link <- sapply(post.object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count) - diag(x@net$count)})
weight.minmax <- c(min(num.link), max(num.link))

for (i in 1:length(post.object.list)) {
  post.object.list[[i]] <- netAnalysis_computeCentrality(object = post.object.list[[i]])
}

gg <- list()
for (i in 1:length(post.object.list)) {
    gg[[i]] <- netAnalysis_signalingRole_scatter(post.object.list[[i]], title= names(post.object.list)[i], weight.MinMax = weight.minmax)
}
patchwork::wrap_plots(plots = gg)


## Compare signaling pathways of MHC and PD-1 pathways

genes <- c('MHC-I', 'MHC-I1', 'MHC-II', 'MHC-II1', 'PD-L1', 'PD-L11', 'PDL2', 'PDL21')

gg1 <- rankNet(post.response.cellchat, mode="comparison", stacked=T, do.stat=TRUE)
gg1.data.filter <- gg1$data[genes, ]

for (i in 1:nrow(gg1.data.filter)) {
  gg1.data.filter$relative[i] <- gg1.data.filter$contribution[i] / (gg1.data.filter$contribution[ceil(i/2)*2-1] + gg1.data.filter$contribution[ceil(i/2)*2])
}

post.signaling.ranknet <- ggplot(gg1.data.filter, aes(x=relative, y=name, fill=group)) + geom_bar(stat="identity") +
  geom_vline(xintercept=0.50, linetype="solid", color="black", size=1) + theme_bw() +
  labs(x="Relative Information Flow", y="Signaling Pathway", fill="Response", title="Post-Treatment") +
  theme(legend.position="bottom", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5))


## Identify signaling networks/groups with larger or less difference based on their functional and structural similarity

post.response.cellchat <- computeNetSimilarityPairwise(post.response.cellchat, type = "functional")
post.response.cellchat <- netEmbedding(post.response.cellchat, type = "functional")
post.response.cellchat <- netClustering(post.response.cellchat, type = "functional")
netVisual_embeddingPairwise(post.response.cellchat, type = "functional")

post.response.cellchat <- computeNetSimilarityPairwise(post.response.cellchat, type = "structural")
post.response.cellchat <- netEmbedding(post.response.cellchat, type = "structural")
post.response.cellchat <- netClustering(post.response.cellchat, type = "structural")
netVisual_embeddingPairwise(post.response.cellchat, type = "structural")


```



Comparison of responders pretreatment vs. posttreatment

```{r}

## Define clusters and pathways of interest

celltypes <- c("CD8_activation", "CD8_exhausted", "CD8_memory", "CD4", "Tregs", "T_proliferation", "Tumor 1", "Tumor 2")
pathways <- c("MHC-I", "MHC-II", "PD-L1", "PDL2")

responder.object.list <- list(Pretreatment = BCC.pre.responders.cellchat, Posttreatment = BCC.post.responders.cellchat)
responder.treatment.cellchat <- mergeCellChat(responder.object.list, add.names = names(responder.object.list))


## Compare total number of interactions and interaction strength

interaction1 <- compareInteractions(responder.treatment.cellchat, show.legend = F, group = c(1,2))
interaction2 <- compareInteractions(responder.treatment.cellchat, show.legend = F, group = c(1,2), measure = "weight")
interaction1 + interaction2

## Differential interaction strength among different cell populations

netVisual_diffInteraction(responder.treatment.cellchat, sources.use = celltypes, targets.use = celltypes, weight.scale = T, measure = "weight", remove.isolate = T, title="Differential Interaction Strength: \nBCC Responders Pretreatment vs. Posttreatment")

gg1 <- netVisual_heatmap(responder.treatment.cellchat)
gg2 <- netVisual_heatmap(responder.treatment.cellchat, measure="weight")

gg1.data.filter <- gg1@matrix[celltypes, celltypes]
gg1.data.filter <- melt(gg1.data.filter)
gg1.data.filter[is.na(gg1.data.filter)] <- 0
gg2.data.filter <- gg2@matrix[celltypes, celltypes]
gg2.data.filter <- melt(gg2.data.filter)
gg2.data.filter[is.na(gg2.data.filter)] <- 0

counts.heatmap.filter <- ggplot(data=gg1.data.filter, aes(x=Var2, y=Var1, fill=value)) + geom_tile() +
  scale_fill_distiller(palette="RdBu", limits = c(-95, 95)) + theme_bw() +
  labs(y="Sources (Outgoing)", x="Receptors (Incoming)", fill="", title="Differential Number of Interactions") + 
  theme(legend.position="right", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5), axis.text.x = element_text(angle=90, vjust=0.5, hjust=1))

weight.heatmap.filter <- ggplot(data=gg2.data.filter, aes(x=Var2, y=Var1, fill=value)) + geom_tile() +
  scale_fill_distiller(palette="RdBu", limits = c(-1.6, 1.6)) + theme_bw() +
  labs(y="Sources (Outgoing)", x="Receptors (Incoming)", fill="", title="Differential Interaction Strength") +
  theme(legend.position="right", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5), axis.text.x = element_text(angle=90, vjust=0.5, hjust=1))

## Heatmaps of pathway communication probabilities 

netVisual_heatmap(BCC.pre.responders.cellchat, signaling = "MHC-I", title.name = "MHC-I Signaling Network: BCC Pretreatment Responders")
netVisual_heatmap(BCC.post.responders.cellchat, signaling = "MHC-I", title.name = "MHC-I Signaling Network: BCC Posttreatment Responders")

netVisual_heatmap(BCC.pre.responders.cellchat, signaling = "MHC-II", title = "MHC-II Signaling Network: BCC Pretreatment Responders")
netVisual_heatmap(BCC.post.responders.cellchat, signaling = "MHC-II", title = "MHC-II Signaling Network: BCC Posttreatment Responders")

netVisual_heatmap(BCC.pre.responders.cellchat, signaling = "PD-L1", title = "PD-L1 Signaling Network: BCC Pretreatment Responders")
netVisual_heatmap(BCC.post.responders.cellchat, signaling = "PD-L1", title = "PD-L1 Signaling Network: BCC Posttreatment Responders")

netVisual_heatmap(BCC.pre.responders.cellchat, signaling = "PDL2", title = "PD-L2 Signaling Network: BCC Pretreatment Responders")
netVisual_heatmap(BCC.post.responders.cellchat, signaling = "PDL2", title = "PD-L2 Signaling Network: BCC Posttreatment Responders")


## Identify signals contributing most to outgoing/incoming signaling of cell groups

BCC.pre.responders.cellchat <- netAnalysis_computeCentrality(BCC.pre.responders.cellchat)
BCC.post.responders.cellchat <- netAnalysis_computeCentrality(BCC.post.responders.cellchat)

netAnalysis_signalingRole_heatmap(BCC.pre.responders.cellchat, pattern="outgoing", signaling=c("MHC-I", "MHC-II", "PD-L1", "PD-L2"), height=3) ##PD-L1 and PD-L2 don't show anything

netAnalysis_signalingRole_heatmap(BCC.pre.responders.cellchat, pattern="incoming", signaling=c("MHC-I", "MHC-II", "PD-L1", "PD-L2"), height=3)


## Identify signaling networks/groups with larger or less difference based on their functional and structural similarity

responder.treatment.cellchat <- computeNetSimilarityPairwise(responder.treatment.cellchat, type = "functional")
responder.treatment.cellchat <- netEmbedding(responder.treatment.cellchat, type = "functional")
responder.treatment.cellchat <- netClustering(responder.treatment.cellchat, type = "functional")
netVisual_embeddingPairwise(responder.treatment.cellchat, type = "functional")

responder.treatment.cellchat <- computeNetSimilarityPairwise(responder.treatment.cellchat, type = "structural")
responder.treatment.cellchat <- netEmbedding(responder.treatment.cellchat, type = "structural")
responder.treatment.cellchat <- netClustering(responder.treatment.cellchat, type = "structural")
netVisual_embeddingPairwise(responder.treatment.cellchat, type = "structural")

```



Comparison of nonresponders pretreatment vs. posttreatment

```{r}

## Define clusters and pathways of interest

celltypes <- c("CD8_activation", "CD8_exhausted", "CD8_memory", "CD4", "Tregs", "T_proliferation", "Macrophages", "Tumor 1", "Tumor 2", "B cells")
pathways <- c("MHC-I", "MHC-II", "PD-L1", "PDL2")

nonresponder.object.list <- list(Pretreatment = BCC.pre.nonresponders.cellchat, Posttreatment = BCC.post.nonresponders.cellchat)
nonresponder.treatment.cellchat <- mergeCellChat(nonresponder.object.list, add.names = names(nonresponder.object.list))


## Compare total number of interactions and interaction strength

interaction1 <- compareInteractions(nonresponder.treatment.cellchat, show.legend = F, group = c(1,2))
interaction2 <- compareInteractions(nonresponder.treatment.cellchat, show.legend = F, group = c(1,2), measure = "weight")
interaction1 + interaction2

## Differential interaction strength among different cell populations

netVisual_diffInteraction(nonresponder.treatment.cellchat, sources.use = celltypes, targets.use = celltypes, weight.scale = T, measure = "weight", remove.isolate = T, title="Differential Interaction Strength: \nBCC Nonresponders Pretreatment vs. Posttreatment")

gg1 <- netVisual_heatmap(nonresponder.treatment.cellchat)
gg2 <- netVisual_heatmap(nonresponder.treatment.cellchat, measure="weight")

gg1.data.filter <- gg1@matrix[celltypes, celltypes]
gg1.data.filter <- melt(gg1.data.filter)
gg1.data.filter[is.na(gg1.data.filter)] <- 0
gg2.data.filter <- gg2@matrix[celltypes, celltypes]
gg2.data.filter <- melt(gg2.data.filter)
gg2.data.filter[is.na(gg2.data.filter)] <- 0

counts.heatmap.filter <- ggplot(data=gg1.data.filter, aes(x=Var2, y=Var1, fill=value)) + geom_tile() +
  scale_fill_distiller(palette="RdBu", limits = c(-95, 95)) + theme_bw() +
  labs(y="Sources (Outgoing)", x="Receptors (Incoming)", fill="", title="Differential Number of Interactions") + 
  theme(legend.position="right", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5), axis.text.x = element_text(angle=90, vjust=0.5, hjust=1))

weight.heatmap.filter <- ggplot(data=gg2.data.filter, aes(x=Var2, y=Var1, fill=value)) + geom_tile() +
  scale_fill_distiller(palette="RdBu", limits = c(-1.6, 1.6)) + theme_bw() +
  labs(y="Sources (Outgoing)", x="Receptors (Incoming)", fill="", title="Differential Interaction Strength") +
  theme(legend.position="right", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5), axis.text.x = element_text(angle=90, vjust=0.5, hjust=1))

## Heatmaps of pathway communication probabilities 

netVisual_heatmap(BCC.pre.nonresponders.cellchat, signaling = "MHC-I", title.name = "MHC-I Signaling Network: BCC Pretreatment nonresponders")
netVisual_heatmap(BCC.post.nonresponders.cellchat, signaling = "MHC-I", title.name = "MHC-I Signaling Network: BCC Posttreatment nonresponders")

netVisual_heatmap(BCC.pre.nonresponders.cellchat, signaling = "MHC-II", title = "MHC-II Signaling Network: BCC Pretreatment nonresponders")
netVisual_heatmap(BCC.post.nonresponders.cellchat, signaling = "MHC-II", title = "MHC-II Signaling Network: BCC Posttreatment nonresponders")

netVisual_heatmap(BCC.pre.nonresponders.cellchat, signaling = "PD-L1", title = "PD-L1 Signaling Network: BCC Pretreatment nonresponders")
netVisual_heatmap(BCC.post.nonresponders.cellchat, signaling = "PD-L1", title = "PD-L1 Signaling Network: BCC Posttreatment nonresponders")

netVisual_heatmap(BCC.pre.nonresponders.cellchat, signaling = "PDL2", title = "PD-L2 Signaling Network: BCC Pretreatment nonresponders")
netVisual_heatmap(BCC.post.nonresponders.cellchat, signaling = "PDL2", title = "PD-L2 Signaling Network: BCC Posttreatment nonresponders")


## Compare outgoing and incoming interaction strengths

weight.max <- list()
weight.max <- getMaxWeight(nonresponder.object.list, attribute = c("idents", "count"))
for (i in 1:length(nonresponder.object.list)) {
  netVisual_circle(nonresponder.object.list[[i]]@net$count, weight.scale = T, label.edge = F, edge.weight.max = weight.max[2], edge.width.max = 12, title.name = paste0("Number of interactions: ", names(nonresponder.object.list)[i]))
}

num.link <- sapply(nonresponder.object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count) - diag(x@net$count)})
weight.minmax <- c(min(num.link), max(num.link))

for (i in 1:length(nonresponder.object.list)) {
  nonresponder.object.list[[i]] <- netAnalysis_computeCentrality(object = nonresponder.object.list[[i]])
}

gg <- list()
for (i in 1:length(nonresponder.object.list)) {
    gg[[i]] <- netAnalysis_signalingRole_scatter(nonresponder.object.list[[i]], title= names(nonresponder.object.list)[i], weight.MinMax = weight.minmax)
}
patchwork::wrap_plots(plots = gg)

## Identify signaling networks/groups with larger or less difference based on their functional and structural similarity (not working)

nonresponder.treatment.cellchat <- computeNetSimilarityPairwise(nonresponder.treatment.cellchat, type = "functional")
nonresponder.treatment.cellchat <- netEmbedding(nonresponder.treatment.cellchat, type = "functional")
nonresponder.treatment.cellchat <- netClustering(nonresponder.treatment.cellchat, type = "functional")
netVisual_embeddingPairwise(nonresponder.treatment.cellchat, type = "functional")

nonresponder.treatment.cellchat <- computeNetSimilarityPairwise(nonresponder.treatment.cellchat, type = "structural")
nonresponder.treatment.cellchat <- netEmbedding(nonresponder.treatment.cellchat, type = "structural")
nonresponder.treatment.cellchat <- netClustering(nonresponder.treatment.cellchat, type = "structural")
netVisual_embeddingPairwise(nonresponder.treatment.cellchat, type = "structural")

```



Compare composition of T cells in BCC patients

```{r}

r.pre.levels <- BCC.pre.responders.cellchat@meta
r.post.levels <- BCC.post.responders.cellchat@meta
nr.pre.levels <- BCC.pre.nonresponders.cellchat@meta
nr.post.levels <- BCC.post.nonresponders.cellchat@meta

r.pre.levels <- r.pre.levels %>% group_by(seurat_clusters) %>% summarise(cells = length(seurat_clusters)) 
r.post.levels <- r.post.levels %>% group_by(seurat_clusters) %>% summarise(cells = length(seurat_clusters)) 
nr.pre.levels <- nr.pre.levels %>% group_by(seurat_clusters) %>% summarise(cells = length(seurat_clusters)) 
nr.post.levels <- nr.post.levels %>% group_by(seurat_clusters) %>% summarise(cells = length(seurat_clusters)) 

levels <- cbind(r.pre.levels, r.post.levels, nr.pre.levels, nr.post.levels)
levels <- levels[c(1, 2, 4, 5, 6, 11), c(1, 2, 4, 6, 8)]
colnames(levels) <- c("Cluster", "R Pre", "R Post", "NR Pre", "NR Post")

for (i in 2:5) {
  levels[, i] <- levels[, i] / sum(levels[, i])
}

levels(levels$Cluster) <- c("CD8+ Memory", "CD4+", "NA", "Tregs", "CD8+ Activated", "CD8+ Exhausted", "NA", "NA", "NA", "NA", "Proliferating", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA")
levels <- melt(levels, id.vars="Cluster")

ggplot(levels, aes(fill=Cluster, y=value, x=variable)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_brewer(palette="Spectral") + theme_bw() +
  labs(y="Proportion", x="Population") +
  theme(legend.position="bottom")

```

#####################################################################################################################

Differential Analysis of BCC Pretreatment vs. PDAC

```{r}

Idents(BCCIO) <- BCCIO$seurat_clusters
Idents(PDAC155698.integrated) <- PDAC155698.integrated$seurat_clusters

BCC.overlap <- subset(BCCIO, idents=c("CD8_activation", "CD8_exhausted", "CD8_memory", "CD4", "Tregs", "Macrophages", "B cells", "NK"))
PDAC.overlap <- subset(PDAC155698.integrated, idents=c("Macrophages", "NK cells", "CD8+ T cells", "B cells", "CD4+ T cells", "Tregs"))

## Rename Idents

rename.ident(BCC.overlap, old.ident.name="CD8_activation", new.ident.name="CD8+ T cells")
rename.ident(BCC.overlap, "CD8_memory", "CD8+ T cells")
rename.ident(BCC.overlap, "CD8_exhausted", "CD8+ T cells")
rename.ident(BCC.overlap, "CD4", "CD4+ T cells")
rename.ident(BCC.overlap, "NK", "NK cells")

## Define clusters and pathways of interest

celltypes <- c("CD8_activation", "CD8_exhausted", "CD8_memory", "CD4", "Tregs", "T_proliferation", "Macrophages", "Tumor 1", "Tumor 2", "B cells")
pathways <- c("MHC-I", "MHC-II", "PD-L1", "PDL2")

pre.object.list <- list(Pretreatment_Responders = BCC.pre.responders.cellchat, Pretreatment_Nonresponders = BCC.pre.nonresponders.cellchat)
pre.response.cellchat <- mergeCellChat(pre.object.list, add.names = names(pre.object.list))


## Compare total number of interactions and interaction strength

interaction1 <- compareInteractions(pre.response.cellchat, show.legend = F, group = c(1,2))
interaction2 <- compareInteractions(pre.response.cellchat, show.legend = F, group = c(1,2), measure = "weight")
interaction1 + interaction2

```


###############################################################################

CellChat Analysis for full PDAC datasets

```{r}

## Create CellChat object and perform preprocessing

pdac.all.cellchat <- createCellChat(object=PDAC.all, meta=PDAC.all@meta.data, group.by="cluster")

CellChatDB <- CellChatDB.human
CellChatDB.use <- subsetDB(CellChatDB, search = "Cell-Cell Adhesion")
CellChatDB.use <- CellChatDB

pdac.all.cellchat@DB <- CellChatDB.use
pdac.all.cellchat <- subsetData(pdac.all.cellchat)

pdac.all.cellchat <- identifyOverExpressedGenes(pdac.all.cellchat)
pdac.all.cellchat <- identifyOverExpressedInteractions(pdac.all.cellchat)
pdac.all.cellchat <- projectData(pdac.all.cellchat, PPI.human)

pdac.all.cellchat <- computeCommunProb(pdac.all.cellchat)
  
save(pdac.all.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\pdac.all.cellchat")

## Look at clustering

pdac.all.cellchat <- computeCommunProb(pdac.all.cellchat)
pdac.all.cellchat <- filterCommunication(pdac.all.cellchat, min.cells=10)

pdac.all.cellchat <- computeCommunProbPathway(pdac.all.cellchat)
pdac.all.cellchat <- aggregateNet(pdac.all.cellchat)

groupSize <- as.numeric(table(pdac.all.cellchat@idents))
netVisual_circle(pdac.all.cellchat@net$count, vertex.weight=groupSize, weight.scale=T, label.edge=F, title.name="Number of Interactions")
netVisual_circle(pdac.all.cellchat@net$weight, vertex.weight=groupSize, weight.scale=T, label.edge=F, title.name="Interaction Weights")

## Cell-cell communication differences between ductal cell clusters

mat <- pdac.all.cellchat@net$weight
par(mfrow = c(2,2), xpd=TRUE)
for (i in 5:8) { # Comparison of ductal cells only 
  mat2 <- matrix(0, nrow=nrow(mat), ncol=ncol(mat), dimnames=dimnames(mat))
  mat2[i,] <- mat[i,]
  netVisual_circle(mat2, vertex.weight=groupSize, weight.scale=T, edge.weight.max=max(mat), title.name=rownames(mat)[i])
}

vertex.receiver = seq(5, 8)
netVisual_aggregate(pdac.all.cellchat, signaling=c("MHC-I"), vertex.receiver=vertex.receiver)
netVisual_aggregate(pdac.all.cellchat, signaling=c("MHC-II"), vertex.receiver=vertex.receiver)
netVisual_aggregate(pdac.all.cellchat, signaling=c("PD-L1"), vertex.receiver=vertex.receiver)
netVisual_aggregate(pdac.all.cellchat, signaling=c("PDL2"), vertex.receiver=vertex.receiver)

## Systems analysis of cell-cell communication network 

pdac.all.cellchat <- netAnalysis_computeCentrality(pdac.all.cellchat, slot.name="netP")
netAnalysis_signalingRole_network(pdac.all.cellchat, signaling=c("MHC-I"), width=16, height=2.5, font.size=10)

netAnalysis_signalingRole_scatter(pdac.all.cellchat, title="All Signaling Pathways")
netAnalysis_signalingRole_scatter(pdac.all.cellchat, signaling=c("MHC-I"), title="MHC-I Pathway")
netAnalysis_signalingRole_scatter(pdac.all.cellchat, signaling=c("MHC-II"), title="MHC-II Pathway")


netAnalysis_signalingRole_heatmap(pdac.all.cellchat, pattern="outgoing", signaling=c("MHC-I", "MHC-II"))
netAnalysis_signalingRole_heatmap(pdac.all.cellchat, pattern="incoming", signaling=c("MHC-I", "MHC-II"))

## Identify global communication patterns

selectK(pdac.all.cellchat, pattern="outgoing")
nPatterns = 5
pdac.all.cellchat <- identifyCommunicationPatterns(pdac.all.cellchat, pattern="outgoing", k=nPatterns)
netAnalysis_river(pdac.all.cellchat, pattern="outgoing")

selectK(pdac.all.cellchat, pattern="incoming")
nPatterns = 4
pdac.all.cellchat <- identifyCommunicationPatterns(pdac.all.cellchat, pattern="incoming", k=nPatterns)
netAnalysis_river(pdac.all.cellchat, pattern="incoming")

## Identify signaling groups based on functional/structural similarities (does not work)

pdac.all.cellchat <- computeNetSimilarity(pdac.all.cellchat, type="functional")
pdac.all.cellchat <- netEmbedding(pdac.all.cellchat, type="functional")
pdac.all.cellchat <- netClustering(pdac.all.cellchat, type="functional")
netVisual_embedding(pdac.all.cellchat, type="functional", label.size=3.5)

```



Create new CellChat object for PDAC with new T cell labels

```{r}


pdac.all.cellchat <- createCellChat(object=PDAC.all, meta=PDAC.all@meta.data, group.by="cluster")

CellChatDB <- CellChatDB.human
CellChatDB.use <- subsetDB(CellChatDB, search = "Cell-Cell Adhesion")
CellChatDB.use <- CellChatDB

pdac.all.cellchat@DB <- CellChatDB.use
pdac.all.cellchat <- subsetData(pdac.all.cellchat)

pdac.all.cellchat <- identifyOverExpressedGenes(pdac.all.cellchat)
pdac.all.cellchat <- identifyOverExpressedInteractions(pdac.all.cellchat)
pdac.all.cellchat <- projectData(pdac.all.cellchat, PPI.human)

pdac.all.cellchat <- computeCommunProb(pdac.all.cellchat)
pdac.all.cellchat <- filterCommunication(pdac.all.cellchat, min.cells=10)

pdac.all.cellchat <- computeCommunProbPathway(pdac.all.cellchat)
pdac.all.cellchat <- aggregateNet(pdac.all.cellchat)

save(pdac.all.cellchat, file="C:\\Users\\Ryan\\Documents\\Nie Research Project\\pdac.all.cellchat")

```



Comparison of PDAC and BCC cells

```{r}

## Merge PDAC and BCC pre-responders CellChat objects

clusternames <- c('CD8+ Memory', 'CD4+ T Cells', 'B cells', 'Tregs', 'CD8+ Effector', 'CD8+ Exhausted', 'Macrophages', 'Plasma cells', 'Malignant 1', 'Miscellaneous', 'Proliferating T cells', 'CAFs', 'NK Cells', 'pDCs', 'Malignant 2', 'Endothelial cells', 'Dendritic cells', 'Myofibroblasts', 'Melanocytes')

levels(BCC.pre.responders.cellchat@meta$seurat_clusters) <- clusternames
levels(BCC.pre.responders.cellchat@idents) <- clusternames

all.celltypes <- unique(c(levels(BCC.pre.responders.cellchat@idents), levels(pdac.all.cellchat@idents)))

pdac.all.cellchat.merge <- liftCellChat(pdac.all.cellchat, all.celltypes)
bcc.preresponders.cellchat.merge <- liftCellChat(BCC.pre.responders.cellchat, all.celltypes)

bcc.preresponders.cellchat.merge@meta$status <- bcc.preresponders.cellchat.merge@meta$treatment
bcc.preresponders.cellchat.merge@meta$orig.ident <- bcc.preresponders.cellchat.merge@meta$patient

pdac.all.cellchat.merge@meta$seurat_clusters <- pdac.all.cellchat.merge@meta$cluster

mergecolumns <- c('orig.ident', 'nCount_RNA', 'nFeature_RNA', 'seurat_clusters', 'status')
bcc.preresponders.cellchat.merge@meta <- bcc.preresponders.cellchat.merge@meta[mergecolumns]
pdac.all.cellchat.merge@meta <- pdac.all.cellchat.merge@meta[mergecolumns]

object.list <- list(PDAC = pdac.all.cellchat.merge, BCC = bcc.preresponders.cellchat.merge)
merged.cellchat <- mergeCellChat(object.list, add.names = names(object.list), cell.prefix=TRUE)

## Reorder ident levels

pathways.show <- c("MHC-I")
weight.max <- getMaxWeight(object.list, slot.name=c("netP"), attribute=pathways.show)
vertex.receiver <- c(1, 2, 4, 5, 6, 11, 13) # T and NK cells

gg1 <- netVisual_aggregate(object.list[[1]], signaling=pathways.show, vertex.receiver=vertex.receiver, edge.weight.max=weight.max[1], edge.width.max=10, signaling.name = paste(pathways.show, names(object.list[1])))
gg2 <- netVisual_aggregate(object.list[[2]], signaling=pathways.show, vertex.receiver=vertex.receiver, edge.weight.max=weight.max[1], edge.width.max=10, signaling.name = paste(pathways.show, names(object.list[2])))

pathways.show <- c("MHC-II")
gg3 <- netVisual_aggregate(object.list[[1]], signaling=pathways.show, vertex.receiver=vertex.receiver, edge.weight.max=weight.max[1], edge.width.max=10, signaling.name = paste(pathways.show, names(object.list[1])))
gg4 <- netVisual_aggregate(object.list[[2]], signaling=pathways.show, vertex.receiver=vertex.receiver, edge.weight.max=weight.max[1], edge.width.max=10, signaling.name = paste(pathways.show, names(object.list[2])))


## Compare overall information flow of MHC signaling pathways

gg1 <- rankNet(merged.cellchat, mode="comparison", stacked=T, do.stat=TRUE)
gg1.mhc.data <- gg1$data[(gg1$data$name == "MHC-I" | gg1$data$name == "MHC-II"),]

all.mhc.ranknet <- ggplot(gg1.mhc.data, aes(fill=group, y=name, x=contribution)) +
  geom_bar(position="fill", stat="identity") + 
  geom_vline(xintercept=0.50, linetype="solid", color="black", size=1) + theme_bw() +
  labs(x="Relative Information Flow", y="Signaling Pathway", fill="Response", title="MHC Pathway Information Flow: All Cells") +
  theme(legend.position="bottom", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5))

gg2 <- rankNet(merged.cellchat, stacked=T, do.stat=TRUE, sources.use=c(1, 2, 4, 5, 6, 11)) # T Cells
gg2.mhc.data <- gg2$data[(gg2$data$name == "MHC-I" | gg2$data$name == "MHC-II"),]

tcell.mhc.ranknet <- ggplot(gg2.mhc.data, aes(fill=group, y=name, x=contribution)) +
  geom_bar(position="fill", stat="identity") + 
  geom_vline(xintercept=0.50, linetype="solid", color="black", size=1) + theme_bw() +
  labs(x="Relative Information Flow", y="Signaling Pathway", fill="Response", title="MHC Pathway: T Cells") +
  theme(legend.position="bottom", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5))

gg3 <- rankNet(merged.cellchat, stacked=T, do.stat=TRUE, sources.use=c(7)) # Macrophages
gg3.mhc.data <- gg3$data[(gg3$data$name == "MHC-I" | gg3$data$name == "MHC-II"),]

macrophage.mhc.ranknet <- ggplot(gg3.mhc.data, aes(fill=group, y=name, x=contribution)) +
  geom_bar(position="fill", stat="identity") + 
  geom_vline(xintercept=0.50, linetype="solid", color="black", size=1) + theme_bw() +
  labs(x="Relative Information Flow", y="Signaling Pathway", fill="Response", title="MHC Pathway: Macrophages") +
  theme(legend.position="bottom", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5))

ggarrange(all.mhc.ranknet, tcell.mhc.ranknet, macrophage.mhc.ranknet, ncol=1, common.legend=TRUE, legend="bottom")


## Compare information flow for every cluster

clusters <- c(2, 5, 6, 1, 4, 13, 7, 3, 14, 16, 8)
clusternames <- c('CD4+ T Cells', 'CD8+ Effector', 'CD8+ Exhausted', 'CD8+ Memory', 'Tregs', 'NK Cells', 'Macrophages', 'B Cells', 'pDCs', 'Endothelial Cells', 'Plasma Cells')

all.mhc1data <- gg3.mhc.data # Borrow from previosu section to initialize
all.mhc2data <- gg3.mhc.data
all.mhc1data$cluster <- "Filler"
all.mhc2data$cluster <- "Filler"

for (i in 1:length(clusters)) {
  data <- rankNet(merged.cellchat, stacked=T, do.stat=TRUE, sources.use=clusters[i])
  mhc1data <- data$data[(data$data$name == "MHC-I"),]
  mhc2data <- data$data[(data$data$name == "MHC-II"),]
  mhc1data$cluster <- clusternames[i]
  mhc2data$cluster <- clusternames[i]
  all.mhc1data <- rbind(all.mhc1data, mhc1data)
  all.mhc2data <- rbind(all.mhc2data, mhc2data)
}

all.mhc1data <- all.mhc1data[-c(1:4),]
all.mhc2data <- all.mhc2data[-c(1:4),]

mhc1.ranknet <- ggplot(all.mhc1data, aes(fill=group, y=cluster, x=contribution)) +
  geom_bar(position="fill", stat="identity") + 
  geom_vline(xintercept=0.50, linetype="solid", color="black", size=1) + theme_bw() +
  labs(x="Relative Information Flow", y="Signaling Pathway", fill="Cancer", title="MHC-I Relative Information Flow") +
  theme(legend.position="bottom", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5))

mhc2.ranknet <- ggplot(all.mhc2data, aes(fill=group, y=cluster, x=contribution)) +
  geom_bar(position="fill", stat="identity") + 
  geom_vline(xintercept=0.50, linetype="solid", color="black", size=1) + theme_bw() +
  labs(x="Relative Information Flow", y="Signaling Pathway", fill="Cancer", title="MHC-II Relative Information Flow") +
  theme(legend.position="bottom", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5))

ggarrange(mhc1.ranknet, mhc2.ranknet, common.legend=TRUE, legend="bottom")

## Compare differential interactions / interaction strength (BCC = red, PDAC = blue)

gg1 <- netVisual_heatmap(merged.cellchat)
gg2 <- netVisual_heatmap(merged.cellchat, measure="weight")

cellgroups <- c(2, 5, 6, 1, 11, 4, 7, 9, 15, 22, 23)
gg1.data.filter <- gg1@matrix[cellgroups, cellgroups]
gg1.data.filter <- melt(gg1.data.filter)
gg1.data.filter[is.na(gg1.data.filter)] <- 0
gg2.data.filter <- gg2@matrix[cellgroups, cellgroups]
gg2.data.filter <- melt(gg2.data.filter)
gg2.data.filter[is.na(gg2.data.filter)] <- 0

counts.heatmap.filter <- ggplot(data=gg1.data.filter, aes(x=Var2, y=Var1, fill=value)) + geom_tile() +
  scale_fill_distiller(palette="RdBu", limits = c(-250, 250)) + theme_bw() +
  labs(y="Sources (Outgoing)", x="Receptors (Incoming)", fill="", title="Differential Number of Interactions") + 
  theme(legend.position="right", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5), axis.text.x = element_text(angle=90, vjust=0.5, hjust=1))

weight.heatmap.filter <- ggplot(data=gg2.data.filter, aes(x=Var2, y=Var1, fill=value)) + geom_tile() +
  scale_fill_distiller(palette="RdBu", limits = c(-2.5, 2.5)) + theme_bw() +
  labs(y="Sources (Outgoing)", x="Receptors (Incoming)", fill="", title="Differential Interaction Strength") +
  theme(legend.position="right", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5), axis.text.x = element_text(angle=90, vjust=0.5, hjust=1))

ggarrange(counts.heatmap.filter, weight.heatmap.filter, ncol=1)

## Scatter plot of interaction strength for all cells
  
num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count) - diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link))

object.list[[1]] <- netAnalysis_computeCentrality(object.list[[1]])
object.list[[2]] <- netAnalysis_computeCentrality(object.list[[2]])
gg1 <- netAnalysis_signalingRole_scatter(object.list[[1]], title=names(object.list)[1], weight.MinMax=weight.MinMax)
gg2 <- netAnalysis_signalingRole_scatter(object.list[[2]], title=names(object.list)[2], weight.MinMax=weight.MinMax)

pdac.signaling.scatter.data <- gg1$data
bcc.signaling.scatter.data <- gg2$data
pdac.signaling.scatter.data$cancer <- "PDAC"
bcc.signaling.scatter.data$cancer <- "BCC"
signaling.scatter <- rbind(pdac.signaling.scatter.data, bcc.signaling.scatter.data)

signaling.scatter <- signaling.scatter[!(signaling.scatter$x == 0 & signaling.scatter$y == 0),]

signaling.scatter.tcell <- signaling.scatter[(signaling.scatter$labels == "CD4+ T Cells" |
                                                signaling.scatter$labels == "CD8+ Memory" |
                                                signaling.scatter$labels == "CD8+ Effector" |
                                                signaling.scatter$labels == "CD8+ Exhausted" |
                                                signaling.scatter$labels == "Tregs" |
                                                signaling.scatter$labels == "Proliferating T cells"),]

all.signaling.ggplot <- ggplot(signaling.scatter.tcell, aes(x=x, y=y, shape=cancer, color=labels)) +
  geom_point(aes(size=3)) + theme_bw() + 
  labs(x="Outgoing Interaction Strength", y="Incoming Interaction Strength", title="Signaling Strength: All Pathways") +
  theme(legend.position="right", plot.title = element_text(color="black", size=18, face="bold", hjust=0.5)) +
  guides(color=guide_legend("Celltype", override.aes=list(size=3)), shape=guide_legend("Cancer", override.aes=list(size=3)), size=FALSE) +
  scale_shape_manual(values=c(19, 18))

## MHC-I pathway scatterplot

gg1 <- netAnalysis_signalingRole_scatter(pdac.all.cellchat.merge, signaling=c("MHC-I"), title="MHC-I Pathway", weight.MinMax=weight.MinMax)
gg2 <- netAnalysis_signalingRole_scatter(bcc.preresponders.cellchat.merge, signaling=c("MHC-I"), title="MHC-I Pathway", weight.MinMax=weight.MinMax)

pdac.signaling.scatter.data <- gg1$data
bcc.signaling.scatter.data <- gg2$data
pdac.signaling.scatter.data$cancer <- "PDAC"
bcc.signaling.scatter.data$cancer <- "BCC"
signaling.scatter <- rbind(pdac.signaling.scatter.data, bcc.signaling.scatter.data)

mhc1.signaling.scatter <- signaling.scatter[!(signaling.scatter$x == 0 & signaling.scatter$y == 0),]

mhc1.signaling.ggplot <- ggplot(mhc1.signaling.scatter, aes(x=x, y=y, shape=cancer, color=labels, label=labels)) +
  geom_point(aes(size=3)) + theme_bw() + geom_text_repel() +
  labs(x="Outgoing Interaction Strength", y="Incoming Interaction Strength", title="Signaling Strength: MHC-I") +
  theme(legend.position="right", plot.title = element_text(color="black", size=30, face="bold", hjust=0.5), axis.title.x = element_text(color="black", size=18, face="plain"), axis.title.y = element_text(color="black", size=18, face="plain"), legend.title=element_text(size=16), legend.text=element_text(size=14)) +
  guides(color=FALSE, shape=guide_legend("Cancer", override.aes=list(size=3)), size=FALSE) +
  scale_shape_manual(values=c(19, 18)) + scale_color_manual(values=colorlist[1:29])

## MHC-II pathway scatterplot

pdac.all.cellchat.merge <- netAnalysis_computeCentrality(pdac.all.cellchat.merge)
bcc.preresponders.cellchat.merge <- netAnalysis_computeCentrality(bcc.preresponders.cellchat.merge)
gg1 <- netAnalysis_signalingRole_scatter(pdac.all.cellchat.merge, signaling=c("MHC-II"), title="MHC-I Pathway", weight.MinMax=weight.MinMax)
gg2 <- netAnalysis_signalingRole_scatter(bcc.preresponders.cellchat.merge, signaling=c("MHC-II"), title="MHC-I Pathway", weight.MinMax=weight.MinMax)

pdac.signaling.scatter.data <- gg1$data
bcc.signaling.scatter.data <- gg2$data
pdac.signaling.scatter.data$cancer <- "PDAC"
bcc.signaling.scatter.data$cancer <- "BCC"
signaling.scatter <- rbind(pdac.signaling.scatter.data, bcc.signaling.scatter.data)

mhc2.signaling.scatter <- signaling.scatter[!(signaling.scatter$x == 0 & signaling.scatter$y == 0),]

mhc2.signaling.ggplot <- ggplot(mhc2.signaling.scatter, aes(x=x, y=y, shape=cancer, color=labels, label=labels)) +
  geom_point(aes(size=3)) + theme_bw() + geom_text_repel(aes(size=3), point.size=3) +
  labs(x="Outgoing Interaction Strength", y="Incoming Interaction Strength", title="Signaling Strength: MHC-II") +
  theme(legend.position="right", plot.title = element_text(color="black", size=30, face="bold", hjust=0.5), axis.title.x = element_text(color="black", size=18, face="plain"), axis.title.y = element_text(color="black", size=18, face="plain"), legend.title=element_text(size=16), legend.text=element_text(size=14)) +
  guides(color=FALSE, shape=guide_legend("Cancer", override.aes=list(size=3)), size=FALSE) +
  scale_shape_manual(values=c(19, 18)) + scale_color_manual(values=colorlist[1:29])

ggarrange(mhc1.signaling.ggplot, NULL, mhc2.signaling.ggplot, common.legend=TRUE, legend="bottom", widths=c(1, 0.15, 1), ncol=3)

```
